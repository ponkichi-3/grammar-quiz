<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>æ–‡æ³•è¨˜è¿°ãƒ†ã‚¹ãƒˆï¼ˆç¢ºèªå¼ï¼‹å¾©ç¿’ / ç®¡ç†ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ FIX9ï¼‰</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Hiragino Sans',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;overflow-x:hidden}
.container{background:#fff;border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,.1);max-width:900px;width:100%}
h1,h2{text-align:center;color:#333;margin-bottom:18px}
h1{font-size:26px}
.sub{font-size:13px;text-align:center;color:#718096;margin-bottom:18px}
.button{display:block;width:100%;padding:12px;margin-bottom:12px;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;transition:.2s;color:#fff;text-align:center;-webkit-appearance:none}
.button:hover{transform:translateY(-1px);box-shadow:0 5px 12px rgba(0,0,0,.2)}
.button-purple{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
.button-green{background:linear-gradient(135deg,#48bb78 0%,#2f855a 100%)}
.button-blue{background:linear-gradient(135deg,#3182ce 0%,#2c5282 100%)}
.button-gray{background:linear-gradient(135deg,#718096 0%,#4a5568 100%)}
.button-orange{background:linear-gradient(135deg,#ed8936 0%,#c05621 100%)}
.button-red{background:linear-gradient(135deg,#f56565 0%,#c53030 100%)}
.hidden{display:none !important}
.form-group{margin-bottom:14px}
label{display:block;margin-bottom:6px;font-weight:700;color:#4a5568;font-size:14px}
select,input[type=text]{width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:16px;transition:border-color .2s}
select:focus,input[type=text]:focus{outline:none;border-color:#667eea}
.checkbox-group{max-height:220px;overflow-y:auto;border:2px solid #e2e8f0;border-radius:8px;padding:12px}
.select-controls{display:flex;gap:10px;margin:8px 0}
.select-button{padding:8px 12px;border:2px solid #667eea;border-radius:8px;background:#fff;color:#667eea;cursor:pointer;font-size:14px;font-weight:600;transition:.15s}
.select-button:hover{background:#667eea;color:#fff}
.progress-bar{height:8px;background:#e2e8f0;border-radius:4px;margin-bottom:12px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,#667eea 0%,#48bb78 100%);transition:width .3s;border-radius:4px}
.timer{font-size:16px;color:#667eea;font-weight:700;text-align:center;margin-bottom:8px}
.quiz-container{text-align:left}
.question-box{background:#f8f9fa;border-radius:12px;padding:18px;margin-bottom:14px}
.question-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.question-number{font-size:14px;color:#718096;font-weight:600}
.point-badge{background:#667eea;color:#fff;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:700}
.question-title{font-size:13px;color:#4a5568;margin-bottom:6px;font-weight:600}
.question-text{font-size:20px;font-weight:700;color:#2d3748;line-height:1.5}
.model-answer{margin-top:10px;padding:12px;background:#e6fffa;border:2px solid #38b2ac;border-radius:8px;display:none}
.model-answer-label{font-size:12px;color:#2c7a7b;font-weight:700;margin-bottom:4px}
.model-answer-text{color:#234e52;font-size:15px;line-height:1.5}
.rate-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
.rate-btn{padding:10px;border:2px solid #e2e8f0;border-radius:10px;background:#fff;cursor:pointer;font-weight:700;transition:.15s}
.rate-btn.perfect{border-color:#48bb78}
.rate-btn.some{border-color:#ed8936}
.rate-btn.none{border-color:#f56565}
.rate-btn.selected{background:#f0f4ff;border-color:#667eea}
.rate-note{font-size:12px;color:#718096;text-align:center;margin-top:4px}
#rateFeedback{font-size:12px;color:#2c5282;text-align:center;margin-top:6px;display:none}
.example-box{margin-top:10px;padding:12px;border:1px solid #e2e8f0;border-radius:8px;background:#f9fafb}
.example-dim{color:#718096}
.hint-box{margin-top:10px;padding:12px;background:#fff7ed;border:2px solid #ed8936;border-radius:8px;display:none}
.hint-label{font-size:12px;color:#c05621;font-weight:700;margin-bottom:4px}
.hint-text{color:#7b341e;font-size:15px;line-height:1.5}
.hint-btn{display:inline-block;padding:8px 12px;border:2px solid #ed8936;border-radius:8px;background:#fff;cursor:pointer;font-size:14px;font-weight:700;color:#c05621;margin-top:10px}
.result-details{background:#f7fafc;border-radius:12px;padding:16px;margin:14px 0}
.result-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #e2e8f0}
.result-item:last-child{border-bottom:none}
.score-display{font-size:56px;font-weight:800;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin:10px 0;text-align:center}
.small{font-size:12px;color:#718096;text-align:center;margin-top:6px}
@media (max-width:480px){.rate-grid{grid-template-columns:1fr} .question-text{font-size:18px} .score-display{font-size:48px}}
#err{display:none;margin-bottom:10px;padding:10px;border-radius:8px;background:#FED7D7;color:#822727;font-weight:700}

/* Persistent home FAB */
.home-fab{
  position:fixed; right:16px; bottom:16px; z-index:1000;
  display:flex; align-items:center; gap:8px;
  border:none; border-radius:999px; padding:10px 14px;
  font-weight:800; font-size:14px; cursor:pointer;
  background:linear-gradient(135deg,#805ad5 0%, #4c51bf 100%); color:#fff;
  box-shadow:0 10px 25px rgba(0,0,0,.2);
}
.home-fab:active{ transform:translateY(1px); }
.home-fab .icon{ font-size:18px; line-height:1; }

/* ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
.mgmt-grid{display:grid;grid-template-columns:1fr;gap:16px}
.mgmt-section{border:1px solid #e2e8f0;border-radius:12px;padding:14px;background:#f9fafb}
.mgmt-title{font-weight:800;font-size:16px;color:#2d3748;margin-bottom:8px}
.mgmt-note{font-size:12px;color:#718096;margin-top:6px}
.item-list{max-height:360px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
.item-row{padding:10px 12px;border-bottom:1px solid #edf2f7}
.item-row:last-child{border-bottom:none}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700;background:#edf2ff;color:#374ea2;margin-left:6px}
.inline-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.inline-btn{padding:6px 10px;border:2px solid #667eea;border-radius:8px;background:#fff;color:#667eea;font-weight:700;cursor:pointer}
.inline-btn:hover{background:#667eea;color:#fff}
.code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px;color:#4a5568;background:#edf2f7;border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
<div class="container">
  <div id="err"></div>
  <div id="homeScreen">
    <h1>æ–‡æ³•ãƒ†ã‚¹ãƒˆï¼ˆç¢ºèªå¼ï¼‹å¾©ç¿’ï¼‰</h1>
    <div class="sub">ver.14M9 / é«˜æ ¡è‹±èªæ–‡æ³• å®šç¾©å•é¡Œ</div>
    <button class="button button-purple" onclick="startGrammarTest()">ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</button>
    <button class="button button-orange" onclick="showPracticeMode()">ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</button>
    <button class="button button-green" onclick="startReviewMode()">å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰</button>
    <button class="button button-blue" onclick="showManagement()">ç®¡ç†ãƒ¢ãƒ¼ãƒ‰</button>
    <div class="small">CSVã¯åŒãƒ•ã‚©ãƒ«ãƒ€ã® <code id="csvNameNote">grammar_definition_with_examples2.csv</code> ã‚’è‡ªå‹•èª­è¾¼ã—ã¾ã™ã€‚</div>
  </div>

  <div id="settingsScreen" class="hidden">
    <h2>è¨­å®š</h2>
    <div class="form-group">
      <label>ãƒ¢ãƒ¼ãƒ‰</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px">
        <div id="modeTest" class="select-button" style="text-align:center" onclick="selectMode('test')">ãƒ†ã‚¹ãƒˆ</div>
        <div id="modePractice" class="select-button" style="text-align:center" onclick="selectMode('practice')">ç·´ç¿’</div>
      </div>
      <div class="sub" id="modeNote">ã€Œè§£ç­”ã‚’ç¢ºèªã€ã§æ­£è§£ã‚’è¡¨ç¤º â†’ è¨˜æ†¶åº¦ã‚’3æŠã§è‡ªå·±è©•ä¾¡ã—ã¾ã™ï¼ˆè¨˜è¿°å¼ãªã—ï¼‰</div>
    </div>

    <div class="form-group">
      <label>æ–‡æ³•å¤§é …ç›®ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
      <div class="select-controls">
        <button class="select-button" onclick="selectAllMajorCategories()">å…¨ã¦é¸æŠ</button>
        <button class="select-button" onclick="deselectAllMajorCategories()">å…¨ã¦è§£é™¤</button>
      </div>
      <div class="checkbox-group" id="majorGroup"></div>
    </div>

    <div class="form-group">
      <label>æ–‡æ³•å°é …ç›®ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
      <div class="select-controls">
        <button class="select-button" onclick="selectAllItems()">å…¨ã¦é¸æŠ</button>
        <button class="select-button" onclick="deselectAllItems()">å…¨ã¦è§£é™¤</button>
      </div>
      <div class="checkbox-group" id="subCategoryGroup"></div>
    </div>

    <div class="form-group">
      <label>å‡ºé¡Œé †</label>
      <select id="questionOrder">
        <option value="sequential">é †ç•ªé€šã‚Š</option>
        <option value="shuffle">ã‚·ãƒ£ãƒƒãƒ•ãƒ«</option>
      </select>
    </div>

    <div class="form-group">
      <label>å•é¡Œæ•°</label>
      <select id="questionCount">
        <option value="5">5å•</option>
        <option value="10" selected>10å•</option>
        <option value="all">å…¨å•é¡Œ</option>
      </select>
    </div>

    <div class="form-group" id="timeLimitGroup">
      <label>åˆ¶é™æ™‚é–“ï¼ˆãƒ†ã‚¹ãƒˆã®ã¿ï¼‰</label>
      <select id="timeLimit">
        <option value="5">5åˆ†</option>
        <option value="10" selected>10åˆ†</option>
        <option value="15">15åˆ†</option>
        <option value="0">ç„¡åˆ¶é™</option>
      </select>
    </div>

    <div id="studentInfoGroup">
      <div class="form-group">
        <label>æ°åï¼ˆãƒ†ã‚¹ãƒˆã®ã¿ä»»æ„ï¼‰</label>
        <input id="studentName" type="text" placeholder="ä¾‹: å±±ç”°å¤ªéƒ"/>
      </div>
    </div>

    <div class="form-group">
  <label><input type="checkbox" id="optConceal" checked> è§£ç­”ç¢ºèªã¾ã§å°é …ç›®åã‚’éš ã™ï¼ˆPOINTå«ã‚€ï¼‰</label>
  <div class="small">ãƒ†ã‚¹ãƒˆæœ¬ç•ªã¯ONæ¨å¥¨ã€‚ç·´ç¿’ã§ã¯OFFã«ã—ã¦å­¦ç¿’ã®è¶³å ´ã«ã§ãã¾ã™ã€‚</div>
</div>
<button class="button button-blue" onclick="startTest()">é–‹å§‹</button>
    <button class="button button-gray" onclick="backToHome()">æˆ»ã‚‹</button>
  </div>

  <div id="quizScreen" class="hidden">
    <div id="timer" class="timer"></div>
    <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>

    <div class="quiz-container">
      <div class="question-box">
        <div class="question-header">
          <div id="questionNumber" class="question-number"></div>
          <div id="pointBadge" class="point-badge"></div>
        </div>
        <div id="questionTitle" class="question-title"></div>
        <div id="questionText" class="question-text"></div>

        <!-- 1) ãƒ’ãƒ³ãƒˆ -->
        <button id="hintButton" class="hint-btn" type="button" style="display:none" onclick="toggleHint()">ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹</button>
        <div id="hintBox" class="hint-box">
          <div class="hint-label">ãƒ’ãƒ³ãƒˆ</div>
          <div id="hintText" class="hint-text"></div>
        </div>

        <!-- 2) ä¾‹æ–‡ -->
        <button id="toggleExampleBtn" class="button button-gray" style="margin-top:8px" onclick="toggleExample()">ä¾‹æ–‡ã‚’è¡¨ç¤º</button>
        <div id="exampleBox" class="example-box hidden">
          <div style="font-size:12px;color:#718096;font-weight:700;margin-bottom:6px;">ä¾‹æ–‡</div>
          <div id="exampleEn" style="font-size:15px;color:#2d3748;"></div>
          <div id="exampleJp" style="font-size:14px;color:#4a5568;margin-top:4px;"></div>
          <div id="exampleNone" class="example-dim hidden">ï¼ˆä¾‹æ–‡ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰</div>
        </div>

        <!-- 3) è§£ç­” -->
        <button id="confirmButton" class="button button-blue" onclick="confirmAnswer()">è§£ç­”ã‚’ç¢ºèª</button>
        <div id="modelAnswer" class="model-answer">
          <div class="model-answer-label">æ¨¡ç¯„è§£ç­”</div>
          <div id="modelAnswerText" class="model-answer-text"></div>
        </div>
      </div>

      <div>
        <div id="rateArea" class="hidden">
          <div class="rate-grid">
            <button id="btnPerfect" class="rate-btn perfect" onclick="rateCurrent('perfect')">å®Œç’§ã«è¦šãˆãŸ</button>
            <button id="btnSome" class="rate-btn some" onclick="rateCurrent('some')">ã¾ã å®Œç’§ã§ã¯ãªã„</button>
            <button id="btnNone" class="rate-btn none" onclick="rateCurrent('none')">ãœã‚“ãœã‚“è¦šãˆã‚‰ã‚Œã¦ã„ãªã„</button>
          </div>
          <div id="rateFeedback">ä¿å­˜ã—ã¾ã—ãŸã€‚</div>
          <div class="rate-note">â€»ã€Œã¾ã ã€ã€Œãœã‚“ãœã‚“ã€ã‚’é¸ã¶ã¨è‡ªå‹•çš„ã«å¾©ç¿’ãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã¾ã™ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰</div>
        </div>

        <button id="nextButton" class="button button-blue hidden" onclick="nextQuestion()">æ¬¡ã®å•é¡Œã¸</button>
        <button id="finishButton" class="button button-orange hidden" onclick="finishTest()">ãƒ†ã‚¹ãƒˆã‚’çµ‚äº†</button>
      </div>
    </div>
  </div>

  <div id="resultScreen" class="hidden">
    <h2>çµ‚äº†</h2>
    <div id="scoreDisplay" class="score-display"></div>
    <div class="result-details">
      <div class="result-item"><span>å•é¡Œæ•°</span><span id="totalCount"></span></div>
      <div class="result-item"><span>æ‰€è¦æ™‚é–“</span><span id="elapsedTime"></span></div>
      <div class="result-item"><span>å¾©ç¿’ã«è¿½åŠ </span><span id="reviewAddedCount"></span></div>
    </div>
    <div id="detailedResults"></div>
    <button class="button button-green" onclick="startReviewMode()">å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã§ã‚„ã‚‹</button>
    <button class="button button-gray" onclick="backToHome()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
  </div>

  <!-- ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—ï¼‰ -->
  <div id="managementScreen" class="hidden">
    <h2>ç®¡ç†ãƒ¢ãƒ¼ãƒ‰</h2>
    <div class="mgmt-grid">
      <div class="mgmt-section">
        <div class="mgmt-title">å¾©ç¿’ãƒªã‚¹ãƒˆç®¡ç†</div>
        <div id="reviewListBox" class="item-list"></div>
        <div class="inline-controls">
          <button class="inline-btn" onclick="exportReviewList()">å¾©ç¿’ãƒªã‚¹ãƒˆã‚’æ›¸ãå‡ºã™</button>
          <button class="inline-btn" onclick="importReviewList()">å¾©ç¿’ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€</button>
          <button class="button button-red" style="width:auto" onclick="clearReviewAll()">å¾©ç¿’ãƒªã‚¹ãƒˆã‚’å…¨å‰Šé™¤</button>
        </div>
        <div class="mgmt-note">ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ç«¯æœ«ãŒå¤‰ã‚ã‚‹ã¨ãƒªã‚¹ãƒˆã¯å…±æœ‰ã•ã‚Œã¾ã›ã‚“ã€‚</div>
      </div>
      <div class="mgmt-section">
        <div class="mgmt-title">é …ç›®åˆ¥ã®å•é¡Œä¸€è¦§</div>
        <div class="form-group">
          <label>æ–‡æ³•å°é …ç›®ï¼ˆPOINTï¼‰ã‚’é¸æŠ</label>
          <select id="itemSelector" onchange="renderItemQuestions()">
            <option value="">ï¼ˆå°é …ç›®ã‚’é¸æŠï¼‰</option>
          </select>
        </div>
        <div id="itemInfo" class="small" style="text-align:left;margin-bottom:8px;"></div>
        <div id="itemQuestionsBox" class="item-list"></div>
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="button button-gray" style="width:auto" onclick="backToHome()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
    </div>
  </div>
</div>

<!-- Persistent home button -->
<button class="home-fab" onclick="goHomeSafely()" title="ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹">
  <span class="icon">ğŸ </span><span>ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</span>
</button>

<script>
const DEFAULT_CSVS = ['grammar_definition_with_examples2.csv','grammar_definition.csv'];
document.getElementById('csvNameNote').textContent = DEFAULT_CSVS[0];

// surface errors on screen
window.addEventListener('error', (e)=>{
  const box=document.getElementById('err');
  box.textContent = 'ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¨ãƒ©ãƒ¼: ' + (e.message||'') + 'ï¼ˆè©³ç´°ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’å‚ç…§ï¼‰';
  box.style.display='block';
});

let questionData = [];        
let currentQuestions = [];
let currentQuestion = 0;
let startTime = null;
let timerInterval = null;
let timeLimit = 10;
let testMode = 'test';        
let selectedCategories = [];
let reviewPool = [];          
let reviewAddedNow = 0;
let concealTitles = true;  // å‡ºé¡Œä¸­ã¯ã‚¿ã‚¤ãƒˆãƒ«/POINTã‚’éš ã™ï¼ˆãƒ†ã‚¹ãƒˆæ—¢å®šï¼‰

function showScreen(id){
  ['homeScreen','settingsScreen','quizScreen','resultScreen','managementScreen']
  .forEach(sid => { const el = document.getElementById(sid); if(el) el.classList.add('hidden'); });
  const target=document.getElementById(id);
  if(target) target.classList.remove('hidden');
}
function backToHome(){
  resetState();
  showScreen('homeScreen');
}
function resetState(){
  currentQuestions = [];
  currentQuestion = 0;
  startTime = null;
  if(timerInterval) clearInterval(timerInterval);
  reviewAddedNow = 0;
  const ma=document.getElementById('modelAnswer'); if(ma) ma.style.display='none';
  const ra=document.getElementById('rateArea'); if(ra) ra.classList.add('hidden');
  ['btnPerfect','btnSome','btnNone'].forEach(id=>{
    const b=document.getElementById(id); if(b){ b.classList.remove('selected'); b.disabled=false; }
  });
  const fb=document.getElementById('rateFeedback'); if(fb){ fb.style.display='none'; fb.textContent='ä¿å­˜ã—ã¾ã—ãŸã€‚'; }
  const nb=document.getElementById('nextButton'); if(nb) nb.classList.add('hidden');
  const fb2=document.getElementById('finishButton'); if(fb2) fb2.classList.add('hidden');
  const hb=document.getElementById('hintBox'); if(hb) hb.style.display='none';
  const hbBtn=document.getElementById('hintButton'); if(hbBtn) hbBtn.style.display='none';
  const ex=document.getElementById('exampleBox'); if(ex){ ex.classList.add('hidden'); }
  const exBtn=document.getElementById('toggleExampleBtn'); if(exBtn){ exBtn.textContent='ä¾‹æ–‡ã‚’è¡¨ç¤º'; }
  const exNone=document.getElementById('exampleNone'); if(exNone){ exNone.classList.add('hidden'); }
}

// Safe home navigation
function goHomeSafely(){
  const quizVisible = !document.getElementById('quizScreen').classList.contains('hidden');
  if(quizVisible && currentQuestions.length){
    const ok = confirm('é€²è¡Œä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¦ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');
    if(!ok) return;
  }
  backToHome();
}

document.addEventListener('DOMContentLoaded', async ()=>{
  buildCategoryUI();
  updateSubCategories();
  loadReviewPool();
  await autoLoadCSV();
  buildItemSelector();  // ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ã®é …ç›®ã‚»ãƒ¬ã‚¯ã‚¿ã‚’ä½œæˆ
});

async function autoLoadCSV(){
  for (const name of DEFAULT_CSVS){
    try{
      const res = await fetch(name, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const text = await res.text();
      const rows = parseCSV(text);
      questionData = rowsToQuestions(rows);
      console.log(`[CSV] Loaded ${questionData.length} rows from ${name}`);
      document.getElementById('csvNameNote').textContent = name;
      return;
    }catch(e){
      console.warn(`[CSV] Failed to load ${name}`, e);
    }
  }
  questionData = [
    {id:'001',question:'ç¾åœ¨å½¢ã®å®šç¾©ã¯ï¼Ÿ',answer:'æ˜¨æ—¥ã‚‚ä»Šæ—¥ã‚‚æ˜æ—¥ã‚‚å¤‰ã‚ã‚‰ãªã„',point:'POINT 1',title:'åŸºæœ¬ï¼“æ™‚åˆ¶ã®å®šç¾©',subId:'001'}
  ];
}

// CSV parser
function parseCSV(text){
  const rows=[]; let row=[]; let cur=''; let inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(inQ){
      if(c==='\"'){
        if(n==='\"'){ cur+='\"'; i++; }
        else{ inQ=false; }
      }else cur+=c;
    }else{
      if(c==='\"'){ inQ=true; }
      else if(c===','){ row.push(cur); cur=''; }
      else if(c==='\r'){ /* skip */ }
      else if(c==='\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
      else cur+=c;
    }
  }
  if(cur.length>0 || row.length>0){ row.push(cur); rows.push(row); }
  return rows;
}

// Normalizers
function normalizeHeader(h){
  return (h||'').toString().trim().toLowerCase().replace(/[\s_]+/g,'');
}
function normalizeTitle(s){
  return (s||'')
    .toString()
    .trim()
    .replace(/\u301c/g,'\uff5e')
    .replace(/\s+/g,'')
    ;
}

// Titleâ†’ID map
const titleToItemIdMapRaw = {
  "åŸºæœ¬ï¼“æ™‚åˆ¶ã®å®šç¾©":"001","æ§˜ã€…ãªæœªæ¥è¡¨ç¾":"002","é€²è¡Œå½¢ã®å®šç¾©":"003","é€²è¡Œå½¢ã®ãƒ«ãƒ¼ãƒ«":"004","ã€Œæ™‚ã‚„æ¡ä»¶ã€ã‚’è¡¨ã™å‰¯è©ç¯€ã§ç”¨ã„ã‚‹ç¾åœ¨å½¢":"005",
  "ç¾åœ¨å®Œäº†å½¢ã®ç”¨æ³•â‘ ï½å®Œäº†ãƒ»çµæœãƒ»çµŒé¨“ï½":"006","ç¾åœ¨å®Œäº†å½¢ã®ç”¨æ³•â‘¡ï½ç¶™ç¶šï½":"007","ç¾åœ¨å®Œäº†å½¢ã®ç”¨æ³•â‘¢ï½æ³¨æ„ç‚¹ï½":"008",
  "éå»å®Œäº†å½¢ã®ç”¨æ³•â‘ ï½å®Œäº†ãƒ»çµæœãƒ»çµŒé¨“ï½":"009","éå»å®Œäº†å½¢ã®ç”¨æ³•â‘¡ï½ç¶™ç¶šï½":"010","éå»å®Œäº†å½¢ã®ç”¨æ³•â‘¢ï½å¤§éå»ï½":"011",
  "æœªæ¥å®Œäº†å½¢ã®ç”¨æ³•â‘ ï½å®Œäº†ãƒ»çµæœãƒ»çµŒé¨“ã¨ç¶™ç¶šï½":"012","æœªæ¥å®Œäº†å½¢ã®ç”¨æ³•â‘¡ï½æ³¨æ„ç‚¹ï½":"013","å—å‹•æ…‹ã®åŸºæœ¬":"014","æ§˜ã€…ãªå½¢ã®å—å‹•æ…‹":"015",
  "å—å‹•æ…‹ã®ç–‘å•æ–‡":"016","ç¬¬ï¼”æ–‡å‹ã®å—å‹•æ…‹":"017","ç¬¬ï¼•æ–‡å‹ã®å—å‹•æ…‹":"018","æ€è€ƒèªçŸ¥å‘Šç¤ºå‹•è©ã®å—å‹•æ…‹":"019","æ³¨æ„ã™ã¹ãå—å‹•æ…‹ã®è¡¨ç¾â‘ ï½be knownï½":"020",
  "æ³¨æ„ã™ã¹ãå—å‹•æ…‹ã®è¡¨ç¾â‘¡ï½æ„Ÿæƒ…è¡¨ç¾ï½":"021","æ³¨æ„ã™ã¹ãå—å‹•æ…‹ã®è¡¨ç¾â‘¢ï½è¢«å®³è¡¨ç¾ï½":"022","æ³¨æ„ã™ã¹ãå—å‹•æ…‹ã®è¡¨ç¾â‘£ï½ãã®ä»–ã®é »å‡ºè¡¨ç¾ï½":"023",
  "beå‹•è©ã®ä»£ã‚ã‚Šã«ä½¿ãˆã‚‹ã€Œå‹•ä½œå‹•è©ã€ã¨ã€ŒçŠ¶æ…‹å‹•è©ã€":"024","æ³¨æ„ã™ã¹ãå—å‹•æ…‹ã®è¡¨ç¾â‘¤ï½å—å‹•æ…‹ã‚’ä½¿ã‚ãªã„è¡¨ç¾ï½":"025","ç¾¤å‹•è©ï¼ˆç†Ÿèªï¼‰ã®å—å‹•æ…‹":"026",
  "canã®åŸºæœ¬":"027","couldã‚’ç†è§£ã—ã‚ˆã†":"028","mayã®åŸºæœ¬":"029","mightã®åŸºæœ¬":"030","mustã®åŸºæœ¬":"031","mustã¨have toã®é•ã„ã‚’ç†è§£ã—ã‚ˆã†":"032",
  "shouldã®åŸºæœ¬":"033","shouldã®ä»²é–“â‘ ought toV":"034","shouldã®ä»²é–“â‘¡had better VåŸå½¢":"035","willã®åŸºæœ¬":"036","wouldã®åŸºæœ¬":"037",
  "used to VåŸå½¢ï½ã®åŸºæœ¬":"038","shallã®åŸºæœ¬":"039","needã®åŸºæœ¬":"040","åŠ©å‹•è© have Vp.p.ã‚·ãƒªãƒ¼ã‚º":"041","æ…£ç”¨è¡¨ç¾ã‚·ãƒªãƒ¼ã‚º":"042",
  "thatç¯€ã§ç”¨ã„ã‚‰ã‚Œã‚‹æƒ³å¿µã®shouldâ‘ ":"043","thatç¯€ã§ç”¨ã„ã‚‰ã‚Œã‚‹æƒ³å¿µã®shouldâ‘¡":"044","ä¸å®šè©ã®åŸºæœ¬â‘  åè©çš„ç”¨æ³•":"045","ä¸å®šè©ã®åŸºæœ¬â‘¡ å½¢å®¹è©çš„ç”¨æ³•":"046",
  "ä¸å®šè©ã®åŸºæœ¬â‘¢ å‰¯è©çš„ç”¨æ³•":"047","ï¼³ï¼¶ï¼¯ï¼‹toï¼¶ï½":"048","ä¸å®šè©ã®æ„å‘³ä¸Šã®ä¸»èªâ‘ ":"049","ä¸å®šè©ã®æ„å‘³ä¸Šã®ä¸»èªâ‘¡":"050","ä½¿å½¹å‹•è©ï¼ˆåŸå½¢ä¸å®šè©ï¼‰":"051",
  "çŸ¥è¦šå‹•è©":"052","ï½ã‚ˆã†ã ã‚·ãƒªãƒ¼ã‚º":"053","æ™‚åˆ¶ã®ä¸ä¸€è‡´":"054","æ§˜ã€…ãªå½¢ã®ä¸å®šè©ï½é€²è¡Œå½¢ãƒ»å—å‹•æ…‹ãƒ»å¦å®šï½":"055","ç–‘å•è© toVï½ã‚·ãƒªãƒ¼ã‚º":"056","ç‹¬ç«‹ä¸å®šè©":"057",
  "be to ä¸å®šè©":"058","é›£æ˜“åº¦ã‚’è¡¨ã™å½¢å®¹è©ï¼‹ toVï½":"059","ä»£ä¸å®šè©":"060","ä¸å®šè©ã®ç†Ÿèªâ‘ ":"061","ä¸å®šè©ã®ç†Ÿèªâ‘¡":"062","å‹•åè©ã®åŸºæœ¬":"063",
  "å‹•åè©ã¨ä¸å®šè©ã®é•ã„":"064","å‹•åè©ã®æ„å‘³ä¸Šã®ä¸»èªã¨å¦å®šèªã®ä½ç½®":"065","å‹•åè©ã®å—å‹•æ…‹":"066","æ™‚åˆ¶ã®ä¸ä¸€è‡´":"067","å‹•åè©ã‚’ä½¿ã£ãŸé‡è¦è¡¨ç¾â‘ ":"068",
  "å‹•åè©ã‚’ä½¿ã£ãŸé‡è¦è¡¨ç¾â‘¡":"069","å‹•åè©ã¨ä¸å®šè©â‘ ":"070","å‹•åè©ã¨ä¸å®šè©â‘¡":"071","å‹•åè©ã¨ä¸å®šè©â‘¢":"072","ç¾åœ¨åˆ†è©ã®åŸºæœ¬":"073","éå»åˆ†è©ã®åŸºæœ¬":"074",
  "è£œèªã«ãªã‚‹åˆ†è©ï¼ˆç¬¬ï¼’æ–‡å‹ï¼‰":"075","è£œèªã«ãªã‚‹åˆ†è©ï¼ˆç¬¬ï¼•æ–‡å‹ï¼‰â‘ ":"076","è£œèªã«ãªã‚‹åˆ†è©ï¼ˆç¬¬ï¼•æ–‡å‹ï¼‰â‘¡":"077","åˆ†è©æ§‹æ–‡ã®åŸºæœ¬":"078","åˆ†è©æ§‹æ–‡ã®ä½œã‚Šæ–¹":"079",
  "åˆ†è©æ§‹æ–‡ã®å’Œè¨³":"080","æ™‚åˆ¶ã®ä¸ä¸€è‡´ï¼†ç‹¬ç«‹åˆ†è©æ§‹æ–‡":"081","æ¥ç¶šè©ã‚’çœç•¥ã—ãªã„åˆ†è©æ§‹æ–‡":"082","æ…£ç”¨çš„ãªåˆ†è©æ§‹æ–‡":"083","ä»˜å¸¯çŠ¶æ³ã‚’è¡¨ã™with":"084",
  "å½¢å®¹è©ã«ãªã£ã¡ã¾ã£ãŸåˆ†è©":"085","ç›´æ¥æ³•ã¨ä»®å®šæ³•":"086","ä»®å®šæ³•éå»ï¼ˆç¾åœ¨ã®å¦„æƒ³ï¼‰":"087","ä»®å®šæ³•éå»å®Œäº†ï¼ˆéå»ã®å¦„æƒ³ï¼‰":"088","wishã¨as ifã‚’ç”¨ã„ãŸä»®å®šæ³•":"089",
  "æœªæ¥ã®å¦„æƒ³":"090","ifã®çœç•¥":"091","ifç¯€ã‚’ä½¿ã‚ãªã„ä»®å®šæ³•è¡¨ç¾":"092","ä»®å®šæ³•ã‚’ä½¿ã£ãŸæ…£ç”¨è¡¨ç¾":"093","ä»®å®šæ³•ãƒŸãƒƒã‚¯ã‚¹ï¼ˆéå»ã«ï½ã ã£ãŸã‚‰ã€ã„ã¾â€¦ãªã®ã«ãªãï¼‰":"094",
  "é–¢ä¿‚ä»£åè©ã®åŸºæœ¬":"095","é–¢ä¿‚ä»£åè©that":"096","å‰ç½®è©ã¨é–¢ä¿‚ä»£åè©":"097","é–¢ä¿‚å‰¯è©when":"098","é–¢ä¿‚å‰¯è©whyã¨how":"099","å…ˆè¡Œè©ã‚’çœç•¥ã§ãã‚‹ã‚±ãƒ¼ã‚¹":"100",
  "é–¢ä¿‚è©ã®éåˆ¶é™ç”¨æ³•":"101","éåˆ¶é™ç”¨æ³•ã®ä½¿ã„æ–¹":"102","é–¢ä¿‚å‰¯è©where":"103","é–¢ä¿‚è©ä»£åè©what":"104","é–¢ä¿‚è©ä»£åè©whatã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾":"105",
  "è¤‡åˆé–¢ä¿‚è©ã®æ¦‚è¦":"106","å‰¯è©ç¯€ï¼ˆè­²æ­©ï¼‰ã‚’ä½œã‚‹è¤‡åˆé–¢ä¿‚ä»£åè©â‘ ":"107","å‰¯è©ç¯€ï¼ˆè­²æ­©ï¼‰ã‚’ä½œã‚‹è¤‡åˆé–¢ä¿‚ä»£åè©â‘¡":"108","åè©ç¯€ã‚’ä½œã‚‹è¤‡åˆé–¢ä¿‚ä»£åè©":"109",
  "é–¢ä¿‚ä»£åè©ã¨ã—ã¦ã®thanã¨but":"110","é–¢ä¿‚ä»£åè©ã¨ã—ã¦ã®as":"111","ãƒãƒ‹ã‚¢å‘ã‘é–¢ä¿‚ä»£åè©":"112","åŸç´šæ¯”è¼ƒã®åŸºæœ¬":"113","asã®å€æ•°è¡¨ç¾":"114",
  "asã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘ ":"115","asã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘¡":"116","asã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘¢":"117","æ¯”è¼ƒç´šã®åŸºæœ¬":"118","å·®ã‚’å…·ä½“çš„ã«è¡¨ã™æ¯”è¼ƒç´š":"119",
  "æ¯”è¼ƒç´šã®å€æ•°è¡¨ç¾":"120","ä¸è¦å‰‡å¤‰åŒ–ã™ã‚‹å½¢å®¹è©ãƒ»å‰¯è©":"121","lessã‚’ç”¨ã„ãŸæ¯”è¼ƒç´š":"122","æ¯”è¼ƒç´šã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘ ":"123","æ¯”è¼ƒç´šã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘¡":"124",
  "æ¯”è¼ƒç´šã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘¢":"125","æ¯”è¼ƒç´šã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘£":"126","noã‚’ä½¿ã£ãŸæ¯”è¼ƒè¡¨ç¾â‘ ":"127","noã‚’ä½¿ã£ãŸæ¯”è¼ƒè¡¨ç¾â‘¡":"128","æœ€ä¸Šç´šã®åŸºæœ¬":"129",
  "æœ€ä¸Šç´šã‚’ç”¨ã„ãŸè¡¨ç¾â‘ ":"130","æœ€ä¸Šç´šã‚’ç”¨ã„ãŸè¡¨ç¾â‘¡":"131","æœ€ä¸Šç´šã®æ„å‘³ã‚’è¡¨ã™åŸç´šãƒ»æ¯”è¼ƒè¡¨ç¾":"132"
};
const normalizedTitleMap = {}; Object.keys(titleToItemIdMapRaw).forEach(k => { normalizedTitleMap[normalizeTitle(k)] = titleToItemIdMapRaw[k]; });

function rowsToQuestions(rows){
  if(!rows || !rows.length) return [];
  const rawHeader = rows[0];
  const header = rawHeader.map(normalizeHeader);

  const idx = (name)=> header.indexOf(normalizeHeader(name));
  const idI = idx('id');
  const qI=idx('question');
  const aI=idx('answer');
  const pI=idx('point');
  const tI=idx('title');
  const hI = (idx('hint')>=0?idx('hint'):idx('hints'));
  const eEI = (idx('exampleen')>=0?idx('exampleen'):idx('example_en'));
  const eJI = (idx('examplejp')>=0?idx('examplejp'):idx('example_jp'));

  const out=[];
  for(let i=1;i<rows.length;i++){
    const r=rows[i]; if(!r || r.length===0) continue;
    const get = (I)=> (I>=0 && I<r.length) ? (r[I]||'') : '';

    const idRaw = (get(idI)).toString().trim();
    const id = idRaw.padStart(3,'0');
    const titleRaw = (get(tI)).toString();
    const title = titleRaw.trim();
    const pointRaw = (get(pI)).toString();

    let subId = null;
    const m = pointRaw.match(/(\d{1,3})/);
    if(m){
      const num = parseInt(m[1],10);
      if(num>=1 && num<=132) subId = String(num).padStart(3,'0');
    }
    if(!subId){
      const norm = normalizeTitle(title);
      if(normalizedTitleMap[norm]) subId = normalizedTitleMap[norm];
    }
    if(!subId){ subId = id; }

    out.push({
      id,
      question: (get(qI)).toString().trim(),
      answer: (get(aI)).toString().trim(),
      point: pointRaw.trim(),
      title,
      subId,
      hint: (get(hI)).toString().trim(),
      exampleEn: (get(eEI)).toString().trim(),
      exampleJp: (get(eJI)).toString().trim()
    });
  }
  return out;
}

// Review pool
const REVIEW_KEY='grammarReviewPoolV1';
function loadReviewPool(){
  try{ reviewPool = JSON.parse(localStorage.getItem(REVIEW_KEY)||'[]'); if(!Array.isArray(reviewPool)) reviewPool=[]; }
  catch(_){ reviewPool=[]; }
}
function saveReviewPool(){ localStorage.setItem(REVIEW_KEY, JSON.stringify(reviewPool)); }
function addToReview(q){
  if(!q || !q.id) return;
  if(!reviewPool.some(x=>String(x.id)===String(q.id))){
    reviewPool.push(q);
    saveReviewPool();
    reviewAddedNow++;
  }
}
function removeFromReview(id){
  const before = reviewPool.length;
  reviewPool = reviewPool.filter(x=>String(x.id)!==String(id));
  if(reviewPool.length!==before) saveReviewPool();
}

// Modes
function selectMode(m){
  testMode=m;
  document.getElementById('timeLimitGroup').style.display=(m==='test')?'block':'none';
  document.getElementById('studentInfoGroup').style.display=(m==='test')?'block':'none';

  // concealTitles æ—¢å®šï¼ˆtest:true / practice:falseï¼‰
  concealTitles = (m==='test');
  const opt=document.getElementById('optConceal'); if(opt){ opt.checked = !!concealTitles; }
}
function showPracticeMode(){ showScreen('settingsScreen'); selectMode('practice'); updateSubCategories(); }
function startGrammarTest(){ showScreen('settingsScreen'); selectMode('test'); updateSubCategories(); }

// Start
function startTest(){
  // UIã‚ªãƒ—ã‚·ãƒ§ãƒ³åæ˜ 
  const opt=document.getElementById('optConceal'); if(opt){ concealTitles = !!opt.checked; }
  if(selectedCategories.length===0){ alert('æ–‡æ³•å°é …ç›®ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„'); return; }
  let filtered = questionData.filter(q=>{const sid=String(q.subId||'').trim();const norm=/^\d+$/.test(sid)?sid.padStart(3,'0'):sid.toUpperCase();return selectedCategories.includes(norm);});
  if(filtered.length===0){
    const sel = selectedCategories.join(', ');
    alert(`é¸æŠã—ãŸé …ç›®ã«å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆé¸æŠ: ${sel}ï¼‰ã€‚CSVã®POINTåˆ—ã«æ•°å€¤ãŒå…¥ã£ã¦ã„ã‚‹ã‹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚`);
    return;
  }

  const order=document.getElementById('questionOrder').value;
  if(order==='shuffle') filtered = shuffle(filtered);

  const count=document.getElementById('questionCount').value;
  if(count!=='all') filtered = filtered.slice(0, parseInt(count,10));

  currentQuestions = filtered.map(q=>({...q}));
  currentQuestion = 0; reviewAddedNow=0;

  if(testMode==='test'){
    timeLimit=parseInt(document.getElementById('timeLimit').value||'10',10);
    startTime=Date.now();
    const update=()=>{
      const elapsed=Math.floor((Date.now()-startTime)/1000);
      const remaining=timeLimit*60 - elapsed;
      if(timeLimit>0){
        if(remaining<=0){ clearInterval(timerInterval); finishTest(); return; }
        const mm=String(Math.floor(remaining/60)).padStart(2,'0');
        const ss=String(remaining%60).padStart(2,'0');
        document.getElementById('timer').textContent = `æ®‹ã‚Šæ™‚é–“: ${mm}:${ss}`;
      }else{ document.getElementById('timer').textContent=''; }
    };
    update(); timerInterval=setInterval(update,1000);
  }else{
    document.getElementById('timer').textContent='';
  }

  showScreen('quizScreen');
  renderQuestion();
}

function startReviewMode(){
  loadReviewPool();
  if(!reviewPool.length){ alert('å¾©ç¿’ãƒªã‚¹ãƒˆãŒç©ºã§ã™ã€‚ã€Œã¾ã ï¼ãœã‚“ãœã‚“ã€ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚'); return; }
  testMode='review';
  currentQuestions = reviewPool.map(q=>({...q}));
  currentQuestion=0; reviewAddedNow=0;
  document.getElementById('timer').textContent='';
  showScreen('quizScreen');
  renderQuestion();
}

// Render
function renderQuestion(){
  if(currentQuestion>=currentQuestions.length){ finishTest(); return; }
  const q=currentQuestions[currentQuestion];
  document.getElementById('questionNumber').textContent=`å•${currentQuestion+1} / ${currentQuestions.length}`;
  document.getElementById('pointBadge').textContent = concealTitles ? '' : (q.point||'');
  document.getElementById('questionTitle').innerHTML = concealTitles ? '' : bar2br(q.title||'');
  document.getElementById('questionText').innerHTML = bar2br(q.question||'');
  document.getElementById('modelAnswerText').innerHTML = bar2br(q.answer||'');
  document.getElementById('exampleEn').innerHTML = bar2br(q.exampleEn||'');
  document.getElementById('exampleJp').innerHTML = bar2br(q.exampleJp||'');
  document.getElementById('hintText').innerHTML = bar2br(q.hint||'');

  document.getElementById('modelAnswer').style.display='none';
  document.getElementById('rateArea').classList.add('hidden');
  ['btnPerfect','btnSome','btnNone'].forEach(id=>{
    const b=document.getElementById(id); if(b){ b.classList.remove('selected'); b.disabled=false; }
  });
  const fb=document.getElementById('rateFeedback'); fb.style.display='none'; fb.textContent='ä¿å­˜ã—ã¾ã—ãŸã€‚';

  document.getElementById('nextButton').classList.add('hidden');
  document.getElementById('finishButton').classList.add('hidden');
  document.getElementById('confirmButton').disabled=false;

  const ex=document.getElementById('exampleBox'); ex.classList.add('hidden');
  document.getElementById('toggleExampleBtn').textContent='ä¾‹æ–‡ã‚’è¡¨ç¤º';
  const hasHint = !!(q.hint && q.hint.trim().length);
  document.getElementById('hintButton').style.display = hasHint ? 'inline-block' : 'none';
  document.getElementById('hintBox').style.display='none';
}

function confirmAnswer(){
  document.getElementById('modelAnswer').style.display='block';
  document.getElementById('rateArea').classList.remove('hidden');
  document.getElementById('confirmButton').disabled=true;
  document.getElementById('nextButton').classList.remove('hidden');
  if(currentQuestion === currentQuestions.length-1){
    document.getElementById('finishButton').classList.remove('hidden');
  
  // è§£ç­”ç¢ºèªå¾Œã«ã‚¿ã‚¤ãƒˆãƒ«/POINTã‚’é–‹ç¤º
  try{
    const q=currentQuestions[currentQuestion];
    document.getElementById('pointBadge').textContent = q.point||'';
    document.getElementById('questionTitle').innerHTML = bar2br(q.title||'');
  }catch(_){/*noop*/}
}
  document.getElementById('modelAnswer').scrollIntoView({behavior:'smooth', block:'center'});
}

function rateCurrent(level){
  const q=currentQuestions[currentQuestion];
  ['btnPerfect','btnSome','btnNone'].forEach(id=>{ const b=document.getElementById(id); b.classList.remove('selected'); });
  if(level==='perfect'){ document.getElementById('btnPerfect').classList.add('selected'); }
  if(level==='some'){ document.getElementById('btnSome').classList.add('selected'); }
  if(level==='none'){ document.getElementById('btnNone').classList.add('selected'); }
  const fb=document.getElementById('rateFeedback');
  if(level==='some' || level==='none'){ addToReview(q); fb.textContent='å¾©ç¿’ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸã€‚'; }
  else{ fb.textContent='äº†è§£ã€‚æ¬¡ã¸é€²ã‚ã¾ã™ã€‚'; }
  fb.style.display='block';
}

function nextQuestion(){
  currentQuestion++;
  renderQuestion();
}

function finishTest(){
  if(timerInterval) clearInterval(timerInterval);
  const total = currentQuestions.length;
  let elapsed = 0;
  if(startTime){ elapsed = Math.floor((Date.now()-startTime)/1000); }
  const mm=String(Math.floor(elapsed/60)).padStart(2,'0');
  const ss=String(elapsed%60).padStart(2,'0');

  document.getElementById('totalCount').textContent = total;
  document.getElementById('elapsedTime').textContent = `${mm}:${ss}`;
  document.getElementById('reviewAddedCount').textContent = reviewAddedNow;
  document.getElementById('scoreDisplay').textContent = `${total} å• å®Œäº†`;

  showScreen('resultScreen');
}

// Example/Hint
function toggleExample(){
  const box=document.getElementById('exampleBox');
  const btn=document.getElementById('toggleExampleBtn');
  const q=currentQuestions[currentQuestion]||{};
  const hasAny = (q.exampleEn && q.exampleEn.trim()) || (q.exampleJp && q.exampleJp.trim());
  document.getElementById('exampleNone').classList.toggle('hidden', !!hasAny);
  if(box.classList.contains('hidden')){ box.classList.remove('hidden'); btn.textContent='ä¾‹æ–‡ã‚’éš ã™'; }
  else{ box.classList.add('hidden'); btn.textContent='ä¾‹æ–‡ã‚’è¡¨ç¤º'; }
}
function toggleHint(){
  const box=document.getElementById('hintBox');
  box.style.display = (box.style.display==='none' || box.style.display==='') ? 'block' : 'none';
}

// === ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ ===
function showManagement(){
  renderReviewList();
  buildItemSelector();
  renderItemQuestions();
  showScreen('managementScreen');
}

function renderReviewList(){
  const box=document.getElementById('reviewListBox');
  loadReviewPool();
  if(!reviewPool.length){ box.innerHTML='<div class="item-row" style="text-align:center;color:#718096">ï¼ˆå¾©ç¿’ãƒªã‚¹ãƒˆã¯ç©ºã§ã™ï¼‰</div>'; return; }
  const rows = reviewPool.map(q=>{
    const title = q.title?`<div style="font-size:12px;color:#718096">${escapeHTML(q.title)}</div>`:'';
    return `<div class="item-row">
      <div style="font-weight:700">${escapeHTML(q.id)}. ${escapeHTML(q.question||'')}</div>
      ${title}
      <div class="inline-controls">
        <button onclick="removeFromReview('${q.id}');renderReviewList();" class="inline-btn">å¾©ç¿’ã‹ã‚‰å‰Šé™¤</button>
        <button onclick="previewQA('${q.id}')" class="inline-btn">å†…å®¹ã‚’è¦‹ã‚‹</button>
      </div>
    </div>`;
  }).join('');
  box.innerHTML = rows;
}

function previewQA(id){
  const q = (reviewPool.find(x=>String(x.id)===String(id))) || (questionData.find(x=>String(x.id)===String(id)));
  if(!q){ alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'); return; }
  const msg = `ã€${q.point||''}ã€‘${q.title||''}\n\nå•é¡Œ: ${q.question||''}\n\nãƒ’ãƒ³ãƒˆ: ${q.hint||'(ãªã—)'}\n\nä¾‹æ–‡(EN): ${q.exampleEn||'(ãªã—)'}\nä¾‹æ–‡(JP): ${q.exampleJp||'(ãªã—)'}\n\nè§£ç­”: ${q.answer||''}`;
  alert(msg);
}

function clearReviewAll(){
  if(!confirm('å¾©ç¿’ãƒªã‚¹ãƒˆã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  reviewPool=[]; saveReviewPool(); renderReviewList();
}

// ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆJSONï¼‰
function exportReviewList(){
  loadReviewPool();
  const blob = new Blob([JSON.stringify(reviewPool, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'review_list.json';
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}
function importReviewList(){
  const inp = document.createElement('input');
  inp.type='file'; inp.accept='application/json';
  inp.onchange = (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(reader.result);
        if(Array.isArray(data)){ reviewPool = data; saveReviewPool(); renderReviewList(); alert('èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚'); }
        else alert('å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
      }catch(_){ alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }
    };
    reader.readAsText(file);
  };
  inp.click();
}

// é …ç›®åˆ¥å•é¡Œä¸€è¦§
function buildItemSelector(){
  const sel = document.getElementById('itemSelector');
  if(!sel) return;
  // subId => title ã®ä»£è¡¨å€¤ã‚’ä½œã‚‹ï¼ˆquestionDataã‹ã‚‰ï¼‰
  const map = new Map();
  questionData.forEach(q=>{
    const id = String(q.subId||'').padStart(3,'0');
    const name = q.title || id;
    if(!map.has(id)) map.set(id, name);
  });
  // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ grammarData ã‹ã‚‰ãƒ•ãƒ«ãƒªã‚¹ãƒˆ
  if(map.size===0){
    Object.values(grammarData).forEach(cat=>{
      (cat.items||[]).forEach(it=>{ map.set(it.id, it.name); });
    });
  }
  // ä¸€æ—¦ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰è¿½åŠ 
  sel.innerHTML = '<option value="">ï¼ˆå°é …ç›®ã‚’é¸æŠï¼‰</option>';
  const arr = Array.from(map.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
  arr.forEach(([id, name])=>{
    const opt = document.createElement('option');
    opt.value = id; opt.textContent = `${id}. ${name}`;
    sel.appendChild(opt);
  });
  // æ—¢å­˜é¸æŠãŒã‚ã‚Œã°ç¶­æŒ
  const cur = sel.getAttribute('data-current');
  if(cur){ sel.value = cur; }
}

function renderItemQuestions(){
  const sel = document.getElementById('itemSelector');
  const box = document.getElementById('itemQuestionsBox');
  const info = document.getElementById('itemInfo');
  if(!sel || !box) return;
  const id = sel.value;
  sel.setAttribute('data-current', id);
  if(!id){
    box.innerHTML = '<div class="item-row" style="text-align:center;color:#718096">ï¼ˆå°é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼‰</div>';
    info.textContent='';
    return;
  }
  const list = questionData.filter(q=>String(q.subId).padStart(3,'0')===String(id).padStart(3,'0'));
  info.textContent = `ã“ã®å°é …ç›®ã®å•é¡Œæ•°: ${list.length} ä»¶`;
  if(list.length===0){
    box.innerHTML = '<div class="item-row" style="text-align:center;color:#718096">ï¼ˆã“ã®é …ç›®ã®å•é¡Œã¯CSVã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼‰</div>';
    return;
  }
  box.innerHTML = list.map(q=>{
    const ex = (q.exampleEn||q.exampleJp) ? `<div class="small">ä¾‹: <span class="code">${bar2br(escapeHTML(q.exampleEn||''))}</span> / <span class="code">${bar2br(escapeHTML(q.exampleJp||''))}</span></div>` : '';
    return `<div class="item-row">
      <div><span class="code">${escapeHTML(q.id)}</span> <strong>${escapeHTML(q.question||'')}</strong> <span class="badge">${escapeHTML(q.point||'')}</span></div>
      <div class="small">è§£ç­”: <span class="code">${bar2br(escapeHTML(q.answer||''))}</span></div>
      ${ex}
      <div class="inline-controls">
        <button class="inline-btn" onclick="addToReviewById('${q.id}')">å¾©ç¿’ã«è¿½åŠ </button>
        <button class="inline-btn" onclick="removeFromReview('${q.id}');renderReviewList()">å¾©ç¿’ã‹ã‚‰å‰Šé™¤</button>
        <button class="inline-btn" onclick="previewQA('${q.id}')">å†…å®¹ã‚’è¦‹ã‚‹</button>
      </div>
    </div>`;
  }).join('');
}

function addToReviewById(id){
  const q = questionData.find(x=>String(x.id)===String(id));
  if(!q){ alert('å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'); return; }
  addToReview(q);
  renderReviewList();
  alert('å¾©ç¿’ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸã€‚');
}

// Utils
function bar2br(s){ return (s||'').toString().split('|').join('<br>'); }
function bar2nl(s){ return (s||'').toString().split('|').join('\n'); }

function shuffle(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function escapeHTML(s){ return (s||'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

// Category UI (å‡ºé¡Œè¨­å®šç”¨)
let grammarData = {
  tense:{name:"æ™‚åˆ¶ï¼ˆTENSEï¼‰",items:[
    {id:"001",name:"åŸºæœ¬ï¼“æ™‚åˆ¶ã®å®šç¾©"},{id:"002",name:"æ§˜ã€…ãªæœªæ¥è¡¨ç¾"},{id:"003",name:"é€²è¡Œå½¢ã®å®šç¾©"},
    {id:"004",name:"é€²è¡Œå½¢ã®ãƒ«ãƒ¼ãƒ«"},{id:"005",name:"ã€Œæ™‚ã‚„æ¡ä»¶ã€ã‚’è¡¨ã™å‰¯è©ç¯€ã§ç”¨ã„ã‚‹ç¾åœ¨å½¢"},
    {id:"006",name:"ç¾åœ¨å®Œäº†å½¢ã®ç”¨æ³•â‘ ï½å®Œäº†ãƒ»çµæœãƒ»çµŒé¨“ï½"},{id:"007",name:"ç¾åœ¨å®Œäº†å½¢ã®ç”¨æ³•â‘¡ï½ç¶™ç¶šï½"},
    {id:"008",name:"ç¾åœ¨å®Œäº†å½¢ã®ç”¨æ³•â‘¢ï½æ³¨æ„ç‚¹ï½"},{id:"009",name:"éå»å®Œäº†å½¢ã®ç”¨æ³•â‘ ï½å®Œäº†ãƒ»çµæœãƒ»çµŒé¨“ï½"},
    {id:"010",name:"éå»å®Œäº†å½¢ã®ç”¨æ³•â‘¡ï½ç¶™ç¶šï½"},{id:"011",name:"éå»å®Œäº†å½¢ã®ç”¨æ³•â‘¢ï½å¤§éå»ï½"},
    {id:"012",name:"æœªæ¥å®Œäº†å½¢ã®ç”¨æ³•â‘ ï½å®Œäº†ãƒ»çµæœãƒ»çµŒé¨“ã¨ç¶™ç¶šï½"},{id:"013",name:"æœªæ¥å®Œäº†å½¢ã®ç”¨æ³•â‘¡ï½æ³¨æ„ç‚¹ï½"}
  ]},
  voice:{name:"å—å‹•æ…‹ï¼ˆVOICEï¼‰",items:[
    {id:"014",name:"å—å‹•æ…‹ã®åŸºæœ¬"},{id:"015",name:"æ§˜ã€…ãªå½¢ã®å—å‹•æ…‹"},{id:"016",name:"å—å‹•æ…‹ã®ç–‘å•æ–‡"},
    {id:"017",name:"ç¬¬ï¼”æ–‡å‹ã®å—å‹•æ…‹"},{id:"018",name:"ç¬¬ï¼•æ–‡å‹ã®å—å‹•æ…‹"},{id:"019",name:"æ€è€ƒèªçŸ¥å‘Šç¤ºå‹•è©ã®å—å‹•æ…‹"},
    {id:"020",name:"æ³¨æ„ã™ã¹ãå—å‹•æ…‹ã®è¡¨ç¾â‘ ï½be knownï½"},{id:"021",name:"æ³¨æ„ã™ã¹ãå—å‹•æ…‹ã®è¡¨ç¾â‘¡ï½æ„Ÿæƒ…è¡¨ç¾ï½"},
    {id:"022",name:"æ³¨æ„ã™ã¹ãå—å‹•æ…‹ã®è¡¨ç¾â‘¢ï½è¢«å®³è¡¨ç¾ï½"},{id:"023",name:"æ³¨æ„ã™ã¹ãå—å‹•æ…‹ã®è¡¨ç¾â‘£ï½ãã®ä»–ã®é »å‡ºè¡¨ç¾ï½"},
    {id:"024",name:"beå‹•è©ã®ä»£ã‚ã‚Šã«ä½¿ãˆã‚‹ã€Œå‹•ä½œå‹•è©ã€ã¨ã€ŒçŠ¶æ…‹å‹•è©ã€"},{id:"025",name:"æ³¨æ„ã™ã¹ãå—å‹•æ…‹ã®è¡¨ç¾â‘¤ï½å—å‹•æ…‹ã‚’ä½¿ã‚ãªã„è¡¨ç¾ï½"},
    {id:"026",name:"ç¾¤å‹•è©ï¼ˆç†Ÿèªï¼‰ã®å—å‹•æ…‹"}
  ]},
  auxiliary:{name:"åŠ©å‹•è©ï¼ˆAUXILIARY VERBï¼‰",items:[
    {id:"027",name:"canã®åŸºæœ¬"},{id:"028",name:"couldã‚’ç†è§£ã—ã‚ˆã†"},{id:"029",name:"mayã®åŸºæœ¬"},{id:"030",name:"mightã®åŸºæœ¬"},
    {id:"031",name:"mustã®åŸºæœ¬"},{id:"032",name:"mustã¨have toã®é•ã„ã‚’ç†è§£ã—ã‚ˆã†"},{id:"033",name:"shouldã®åŸºæœ¬"},
    {id:"034",name:"shouldã®ä»²é–“â‘ ought toV"},{id:"035",name:"shouldã®ä»²é–“â‘¡had better VåŸå½¢"},{id:"036",name:"willã®åŸºæœ¬"},
    {id:"037",name:"wouldã®åŸºæœ¬"},{id:"038",name:"used to VåŸå½¢ï½ã®åŸºæœ¬"},{id:"039",name:"shallã®åŸºæœ¬"},
    {id:"040",name:"needã®åŸºæœ¬"},{id:"041",name:"åŠ©å‹•è© have Vp.p.ã‚·ãƒªãƒ¼ã‚º"},{id:"042",name:"æ…£ç”¨è¡¨ç¾ã‚·ãƒªãƒ¼ã‚º"},
    {id:"043",name:"thatç¯€ã§ç”¨ã„ã‚‰ã‚Œã‚‹æƒ³å¿µã®shouldâ‘ "},{id:"044",name:"thatç¯€ã§ç”¨ã„ã‚‰ã‚Œã‚‹æƒ³å¿µã®shouldâ‘¡"}
  ]},
  infinitive:{name:"ä¸å®šè©ï¼ˆINFINITIVEï¼‰",items:[
    {id:"045",name:"ä¸å®šè©ã®åŸºæœ¬â‘  åè©çš„ç”¨æ³•"},{id:"046",name:"ä¸å®šè©ã®åŸºæœ¬â‘¡ å½¢å®¹è©çš„ç”¨æ³•"},{id:"047",name:"ä¸å®šè©ã®åŸºæœ¬â‘¢ å‰¯è©çš„ç”¨æ³•"},
    {id:"048",name:"ï¼³ï¼¶ï¼¯ï¼‹toï¼¶ï½"},{id:"049",name:"ä¸å®šè©ã®æ„å‘³ä¸Šã®ä¸»èªâ‘ "},{id:"050",name:"ä¸å®šè©ã®æ„å‘³ä¸Šã®ä¸»èªâ‘¡"},
    {id:"051",name:"ä½¿å½¹å‹•è©ï¼ˆåŸå½¢ä¸å®šè©ï¼‰"},{id:"052",name:"çŸ¥è¦šå‹•è©"},{id:"053",name:"ï½ã‚ˆã†ã ã‚·ãƒªãƒ¼ã‚º"},{id:"054",name:"æ™‚åˆ¶ã®ä¸ä¸€è‡´"},
    {id:"055",name:"æ§˜ã€…ãªå½¢ã®ä¸å®šè©ï½é€²è¡Œå½¢ãƒ»å—å‹•æ…‹ãƒ»å¦å®šï½"},{id:"056",name:"ç–‘å•è© toVï½ã‚·ãƒªãƒ¼ã‚º"},{id:"057",name:"ç‹¬ç«‹ä¸å®šè©"},
    {id:"058",name:"be to ä¸å®šè©"},{id:"059",name:"é›£æ˜“åº¦ã‚’è¡¨ã™å½¢å®¹è©ï¼‹ toVï½"},{id:"060",name:"ä»£ä¸å®šè©"},
    {id:"061",name:"ä¸å®šè©ã®ç†Ÿèªâ‘ "},{id:"062",name:"ä¸å®šè©ã®ç†Ÿèªâ‘¡"}
  ]},
  gerund:{name:"å‹•åè©ï¼ˆGERUNDï¼‰",items:[
    {id:"063",name:"å‹•åè©ã®åŸºæœ¬"},{id:"064",name:"å‹•åè©ã¨ä¸å®šè©ã®é•ã„"},{id:"065",name:"å‹•åè©ã®æ„å‘³ä¸Šã®ä¸»èªã¨å¦å®šèªã®ä½ç½®"},
    {id:"066",name:"å‹•åè©ã®å—å‹•æ…‹"},{id:"067",name:"æ™‚åˆ¶ã®ä¸ä¸€è‡´"},{id:"068",name:"å‹•åè©ã‚’ä½¿ã£ãŸé‡è¦è¡¨ç¾â‘ "},
    {id:"069",name:"å‹•åè©ã‚’ä½¿ã£ãŸé‡è¦è¡¨ç¾â‘¡"},{id:"070",name:"å‹•åè©ã¨ä¸å®šè©â‘ "},{id:"071",name:"å‹•åè©ã¨ä¸å®šè©â‘¡"},
    {id:"072",name:"å‹•åè©ã¨ä¸å®šè©â‘¢"}
  ]},
  participle:{name:"åˆ†è©ï¼ˆPARTICIPLEï¼‰",items:[
    {id:"073",name:"ç¾åœ¨åˆ†è©ã®åŸºæœ¬"},{id:"074",name:"éå»åˆ†è©ã®åŸºæœ¬"},{id:"075",name:"è£œèªã«ãªã‚‹åˆ†è©ï¼ˆç¬¬ï¼’æ–‡å‹ï¼‰"},
    {id:"076",name:"è£œèªã«ãªã‚‹åˆ†è©ï¼ˆç¬¬ï¼•æ–‡å‹ï¼‰â‘ "},{id:"077",name:"è£œèªã«ãªã‚‹åˆ†è©ï¼ˆç¬¬ï¼•æ–‡å‹ï¼‰â‘¡"},
    {id:"078",name:"åˆ†è©æ§‹æ–‡ã®åŸºæœ¬"},{id:"079",name:"åˆ†è©æ§‹æ–‡ã®ä½œã‚Šæ–¹"},{id:"080",name:"åˆ†è©æ§‹æ–‡ã®å’Œè¨³"},
    {id:"081",name:"æ™‚åˆ¶ã®ä¸ä¸€è‡´ï¼†ç‹¬ç«‹åˆ†è©æ§‹æ–‡"},{id:"082",name:"æ¥ç¶šè©ã‚’çœç•¥ã—ãªã„åˆ†è©æ§‹æ–‡"},{id:"083",name:"æ…£ç”¨çš„ãªåˆ†è©æ§‹æ–‡"},
    {id:"084",name:"ä»˜å¸¯çŠ¶æ³ã‚’è¡¨ã™with"},{id:"085",name:"å½¢å®¹è©ã«ãªã£ã¡ã¾ã£ãŸåˆ†è©"}
  ]},
  subjunctive:{name:"ä»®å®šæ³•ï¼ˆSUBJUNCTIVEï¼‰",items:[
    {id:"086",name:"ç›´æ¥æ³•ã¨ä»®å®šæ³•"},{id:"087",name:"ä»®å®šæ³•éå»ï¼ˆç¾åœ¨ã®å¦„æƒ³ï¼‰"},{id:"088",name:"ä»®å®šæ³•éå»å®Œäº†ï¼ˆéå»ã®å¦„æƒ³ï¼‰"},
    {id:"089",name:"wishã¨as ifã‚’ç”¨ã„ãŸä»®å®šæ³•"},{id:"090",name:"æœªæ¥ã®å¦„æƒ³"},{id:"091",name:"ifã®çœç•¥"},
    {id:"092",name:"ifç¯€ã‚’ä½¿ã‚ãªã„ä»®å®šæ³•è¡¨ç¾"},{id:"093",name:"ä»®å®šæ³•ã‚’ä½¿ã£ãŸæ…£ç”¨è¡¨ç¾"},{id:"094",name:"ä»®å®šæ³•ãƒŸãƒƒã‚¯ã‚¹ï¼ˆéå»ã«ï½ã ã£ãŸã‚‰ã€ã„ã¾â€¦ãªã®ã«ãªãï¼‰"}
  ]},
  relative:{name:"é–¢ä¿‚è©ï¼ˆRELATIVE PRONOUNï¼‰",items:[
    {id:"095",name:"é–¢ä¿‚ä»£åè©ã®åŸºæœ¬"},{id:"096",name:"é–¢ä¿‚ä»£åè©that"},{id:"097",name:"å‰ç½®è©ã¨é–¢ä¿‚ä»£åè©"},
    {id:"098",name:"é–¢ä¿‚å‰¯è©when"},{id:"099",name:"é–¢ä¿‚å‰¯è©whyã¨how"},{id:"100",name:"å…ˆè¡Œè©ã‚’çœç•¥ã§ãã‚‹ã‚±ãƒ¼ã‚¹"},
    {id:"101",name:"é–¢ä¿‚è©ã®éåˆ¶é™ç”¨æ³•"},{id:"102",name:"éåˆ¶é™ç”¨æ³•ã®ä½¿ã„æ–¹"},{id:"103",name:"é–¢ä¿‚å‰¯è©where"},
    {id:"104",name:"é–¢ä¿‚è©ä»£åè©what"},{id:"105",name:"é–¢ä¿‚è©ä»£åè©whatã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾"},
    {id:"106",name:"è¤‡åˆé–¢ä¿‚è©ã®æ¦‚è¦"},{id:"107",name:"å‰¯è©ç¯€ï¼ˆè­²æ­©ï¼‰ã‚’ä½œã‚‹è¤‡åˆé–¢ä¿‚ä»£åè©â‘ "},
    {id:"108",name:"å‰¯è©ç¯€ï¼ˆè­²æ­©ï¼‰ã‚’ä½œã‚‹è¤‡åˆé–¢ä¿‚ä»£åè©â‘¡"},{id:"109",name:"åè©ç¯€ã‚’ä½œã‚‹è¤‡åˆé–¢ä¿‚ä»£åè©"},
    {id:"110",name:"é–¢ä¿‚ä»£åè©ã¨ã—ã¦ã®thanã¨but"},{id:"111",name:"é–¢ä¿‚ä»£åè©ã¨ã—ã¦ã®as"},{id:"112",name:"ãƒãƒ‹ã‚¢å‘ã‘é–¢ä¿‚ä»£åè©"}
  ]},
  comparison:{name:"æ¯”è¼ƒï¼ˆCOMPARISONï¼‰",items:[
    {id:"113",name:"åŸç´šæ¯”è¼ƒã®åŸºæœ¬"},{id:"114",name:"asã®å€æ•°è¡¨ç¾"},{id:"115",name:"asã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘ "},
    {id:"116",name:"asã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘¡"},{id:"117",name:"asã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘¢"},{id:"118",name:"æ¯”è¼ƒç´šã®åŸºæœ¬"},
    {id:"119",name:"å·®ã‚’å…·ä½“çš„ã«è¡¨ã™æ¯”è¼ƒç´š"},{id:"120",name:"æ¯”è¼ƒç´šã®å€æ•°è¡¨ç¾"},{id:"121",name:"ä¸è¦å‰‡å¤‰åŒ–ã™ã‚‹å½¢å®¹è©ãƒ»å‰¯è©"},
    {id:"122",name:"lessã‚’ç”¨ã„ãŸæ¯”è¼ƒç´š"},{id:"123",name:"æ¯”è¼ƒç´šã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘ "},{id:"124",name:"æ¯”è¼ƒç´šã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘¡"},
    {id:"125",name:"æ¯”è¼ƒç´šã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘¢"},{id:"126",name:"æ¯”è¼ƒç´šã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘£"},
    {id:"127",name:"noã‚’ä½¿ã£ãŸæ¯”è¼ƒè¡¨ç¾â‘ "},{id:"128",name:"noã‚’ä½¿ã£ãŸæ¯”è¼ƒè¡¨ç¾â‘¡"},
    {id:"129",name:"æœ€ä¸Šç´šã®åŸºæœ¬"},{id:"130",name:"æœ€ä¸Šç´šã‚’ç”¨ã„ãŸè¡¨ç¾â‘ "},{id:"131",name:"æœ€ä¸Šç´šã‚’ç”¨ã„ãŸè¡¨ç¾â‘¡"},
    {id:"132",name:"æœ€ä¸Šç´šã®æ„å‘³ã‚’è¡¨ã™åŸç´šãƒ»æ¯”è¼ƒè¡¨ç¾"}
  ]}
};

function buildCategoryUI(){
  const major=document.getElementById('majorGroup');
  if(!major) return;
  major.innerHTML='';
  Object.keys(grammarData).forEach(key=>{
    const label=document.createElement('label');
    label.style.display='flex';label.style.alignItems='center';label.style.padding='4px 0';label.style.cursor='pointer';label.style.fontSize='14px';
    label.innerHTML = `<input type="checkbox" value="${key}" style="margin-right:8px" onchange="updateSubCategories()"> ${grammarData[key].name}`;
    major.appendChild(label);
  });
}
function updateSubCategories(){
  const sub=document.getElementById('subCategoryGroup'); if(!sub) return;
  sub.innerHTML='';
  const checkedMajors=[...document.querySelectorAll('#majorGroup input[type=checkbox]:checked')].map(cb=>cb.value);
  const keys = checkedMajors.length?checkedMajors:Object.keys(grammarData);
  keys.forEach(key=>{
    const header=document.createElement('div');
    header.style.fontWeight='700';header.style.color='#667eea';header.style.marginTop='10px';header.style.marginBottom='4px';header.style.fontSize='15px';
    header.textContent = grammarData[key].name;
    sub.appendChild(header);
    grammarData[key].items.forEach(item=>{
      const label=document.createElement('label');
      label.style.display='flex';label.style.alignItems='center';label.style.padding='4px 0';label.style.cursor='pointer';label.style.fontSize='14px';
      label.innerHTML = `<input type="checkbox" value="${item.id}" style="margin-right:8px" onchange="updateSelectedCategories()"> ${item.id}. ${item.name}`;
      sub.appendChild(label);
    });
  });
}
function selectAllMajorCategories(){document.querySelectorAll('#majorGroup input[type=checkbox]').forEach(cb=>cb.checked=true);updateSubCategories();}
function deselectAllMajorCategories(){document.querySelectorAll('#majorGroup input[type=checkbox]').forEach(cb=>cb.checked=false);updateSubCategories();}
function selectAllItems(){document.querySelectorAll('#subCategoryGroup input[type=checkbox]').forEach(cb=>cb.checked=true);updateSelectedCategories();}
function deselectAllItems(){document.querySelectorAll('#subCategoryGroup input[type=checkbox]').forEach(cb=>cb.checked=false);updateSelectedCategories();}
function updateSelectedCategories(){selectedCategories=[...document.querySelectorAll('#subCategoryGroup input[type=checkbox]:checked')].map(cb=>(/^\d+$/.test(cb.value)?cb.value.padStart(3,'0'):cb.value.toUpperCase()));}

// === PATCH: S01-S21è¿½åŠ  & 001-132åç§°ã‚’POINT_list.xlsxã§ä¸Šæ›¸ã ===
(function() {
  const structureItems = [
    {id:'S01', name:'å“è©ã®ç†è§£â‘ ã€€åè©'},
    {id:'S02', name:'å“è©ã®ç†è§£â‘¡ã€€å‹•è©'},
    {id:'S03', name:'å“è©ã®ç†è§£â‘¢ã€€å½¢å®¹è©'},
    {id:'S04', name:'å“è©ã®ç†è§£â‘£ã€€å‰¯è©'},
    {id:'S05', name:'å“è©ã®ç†è§£â‘¤ã€€å‰ç½®è©'},
    {id:'S06', name:'ç¬¬ï¼‘æ–‡å‹ã€€SV'},
    {id:'S07', name:'ç¬¬ï¼’æ–‡å‹ã€€SVC'},
    {id:'S08', name:'ç¬¬ï¼“æ–‡å‹ã€€SVO'},
    {id:'S09', name:'ç¬¬ï¼”æ–‡å‹ã€€SVOO'},
    {id:'S10', name:'ç¬¬ï¼•æ–‡å‹ã€€SVOC'},
    {id:'S11', name:'æ³¨æ„ã™ã¹ãå‹•è©ãŸã¡'},
    {id:'S12', name:'Sã®æ±ºã‚æ–¹'},
    {id:'S13', name:'å‹•è©ã®æ„å‘³ã¯ã€Œå‹ã€ãŒæ±ºã‚ã‚‹'},
    {id:'S14', name:'å“è©â‘ å¯ç®—ãƒ»ä¸å¯ç®—åè©'},
    {id:'S15', name:'å“è©â‘¡å† è©'},
    {id:'S16', name:'å“è©â‘¢ä»£åè©ãƒ»å‹•è©ãƒ»å½¢å®¹è©ãƒ»å‰¯è©'},
    {id:'S17', name:'å“è©â‘£å‰ç½®è©ãƒ»åŠ©å‹•è©ãƒ»æ¥ç¶šè©ãƒ»é–“æŠ•è©ãƒ»å¥ã¨ç¯€'},
    {id:'S18', name:'æ–‡ã®ç¨®é¡â‘ è‚¯å®šæ–‡ãƒ»å¦å®šæ–‡ãƒ»äººç§°ä»£åè©'},
    {id:'S19', name:'æ–‡ã®ç¨®é¡â‘¡ç–‘å•æ–‡'},
    {id:'S20', name:'æ–‡ã®ç¨®é¡â‘¢å‘½ä»¤æ–‡'},
    {id:'S21', name:'æ–‡ã®ç¨®é¡â‘£æ„Ÿå˜†æ–‡ãƒ»There isæ§‹æ–‡'}
  ];
  grammarData = Object.assign({ structure: { name: 'å“è©ãƒ»æ–‡å‹', items: structureItems } }, grammarData);

  const NAME_OVERRIDES = {
  '001':'åŸºæœ¬ï¼“æ™‚åˆ¶ã®å®šç¾©',
  '002':'æ§˜ã€…ãªæœªæ¥è¡¨ç¾',
  '003':'é€²è¡Œå½¢ã®å®šç¾©',
  '004':'é€²è¡Œå½¢ã®ãƒ«ãƒ¼ãƒ«',
  '005':'ã€Œæ™‚ã‚„æ¡ä»¶ã€ã‚’è¡¨ã™å‰¯è©ç¯€ã§ç”¨ã„ã‚‹ç¾åœ¨å½¢',
  '006':'ç¾åœ¨å®Œäº†å½¢ã®ç”¨æ³•â‘ ï½å®Œäº†ãƒ»çµæœãƒ»çµŒé¨“ï½',
  '007':'ç¾åœ¨å®Œäº†å½¢ã®ç”¨æ³•â‘¡ï½ç¶™ç¶šï½',
  '008':'ç¾åœ¨å®Œäº†å½¢ã®ç”¨æ³•â‘¢ï½æ³¨æ„ç‚¹ï½',
  '009':'éå»å®Œäº†å½¢ã®ç”¨æ³•â‘ ï½å®Œäº†ãƒ»çµæœãƒ»çµŒé¨“ï½',
  '010':'éå»å®Œäº†å½¢ã®ç”¨æ³•â‘¡ï½ç¶™ç¶šï½',
  '011':'éå»å®Œäº†å½¢ã®ç”¨æ³•â‘¢ï½å¤§éå»ï½',
  '012':'æœªæ¥å®Œäº†å½¢ã®ç”¨æ³•â‘ ï½å®Œäº†ãƒ»çµæœãƒ»çµŒé¨“ã¨ç¶™ç¶šï½',
  '013':'æœªæ¥å®Œäº†å½¢ã®ç”¨æ³•â‘¡ï½æ³¨æ„ç‚¹ï½',
  '014':'å—å‹•æ…‹ã®åŸºæœ¬',
  '015':'æ§˜ã€…ãªå½¢ã®å—å‹•æ…‹',
  '016':'å—å‹•æ…‹ã®ç–‘å•æ–‡',
  '017':'ç¬¬ï¼”æ–‡å‹ã®å—å‹•æ…‹',
  '018':'ç¬¬ï¼•æ–‡å‹ã®å—å‹•æ…‹',
  '019':'æ€è€ƒèªçŸ¥å‘Šç¤ºå‹•è©ã®å—å‹•æ…‹',
  '020':'æ³¨æ„ã™ã¹ãå—å‹•æ…‹ã®è¡¨ç¾â‘ ï½be knownï½',
  '021':'æ³¨æ„ã™ã¹ãå—å‹•æ…‹ã®è¡¨ç¾â‘¡ï½æ„Ÿæƒ…è¡¨ç¾ï½',
  '022':'æ³¨æ„ã™ã¹ãå—å‹•æ…‹ã®è¡¨ç¾â‘¢ï½è¢«å®³è¡¨ç¾ï½',
  '023':'æ³¨æ„ã™ã¹ãå—å‹•æ…‹ã®è¡¨ç¾â‘£ï½ãã®ä»–ã®é »å‡ºè¡¨ç¾ï½',
  '024':'beå‹•è©ã®ä»£ã‚ã‚Šã«ä½¿ãˆã‚‹ã€Œå‹•ä½œå‹•è©ã€ã¨ã€ŒçŠ¶æ…‹å‹•è©ã€',
  '025':'æ³¨æ„ã™ã¹ãå—å‹•æ…‹ã®è¡¨ç¾â‘¤ï½å—å‹•æ…‹ã‚’ä½¿ã‚ãªã„è¡¨ç¾ï½',
  '026':'ç¾¤å‹•è©ï¼ˆç†Ÿèªï¼‰ã®å—å‹•æ…‹',
  '027':'canã®åŸºæœ¬',
  '028':'couldã‚’ç†è§£ã—ã‚ˆã†',
  '029':'mayã®åŸºæœ¬',
  '030':'mightã®åŸºæœ¬',
  '031':'mustã®åŸºæœ¬',
  '032':'mustã¨have toã®é•ã„ã‚’ç†è§£ã—ã‚ˆã†',
  '033':'shouldã®åŸºæœ¬',
  '034':'shouldã®ä»²é–“â‘ ought toV',
  '035':'shouldã®ä»²é–“â‘¡had better VåŸå½¢',
  '036':'willã®åŸºæœ¬',
  '037':'wouldã®åŸºæœ¬',
  '038':'used to VåŸå½¢ï½ã®åŸºæœ¬',
  '039':'shallã®åŸºæœ¬',
  '040':'needã®åŸºæœ¬',
  '041':'åŠ©å‹•è© have Vp.p.ã‚·ãƒªãƒ¼ã‚º',
  '042':'æ…£ç”¨è¡¨ç¾ã‚·ãƒªãƒ¼ã‚º',
  '043':'thatç¯€ã§ç”¨ã„ã‚‰ã‚Œã‚‹æƒ³å¿µã®shouldâ‘ ',
  '044':'thatç¯€ã§ç”¨ã„ã‚‰ã‚Œã‚‹æƒ³å¿µã®shouldâ‘¡',
  '045':'ä¸å®šè©ã®åŸºæœ¬â‘  åè©çš„ç”¨æ³•',
  '046':'ä¸å®šè©ã®åŸºæœ¬â‘¡ å½¢å®¹è©çš„ç”¨æ³•',
  '047':'ä¸å®šè©ã®åŸºæœ¬â‘¢ å‰¯è©çš„ç”¨æ³•',
  '048':'ï¼³ï¼¶ï¼¯ï¼‹toï¼¶ï½',
  '049':'ä¸å®šè©ã®æ„å‘³ä¸Šã®ä¸»èªâ‘ ',
  '050':'ä¸å®šè©ã®æ„å‘³ä¸Šã®ä¸»èªâ‘¡',
  '051':'ä½¿å½¹å‹•è©ï¼ˆåŸå½¢ä¸å®šè©ï¼‰',
  '052':'çŸ¥è¦šå‹•è©',
  '053':'ï½ã‚ˆã†ã ã‚·ãƒªãƒ¼ã‚º',
  '054':'æ™‚åˆ¶ã®ä¸ä¸€è‡´',
  '055':'æ§˜ã€…ãªå½¢ã®ä¸å®šè©ï½é€²è¡Œå½¢ãƒ»å—å‹•æ…‹ãƒ»å¦å®šï½',
  '056':'ç–‘å•è© toVï½ã‚·ãƒªãƒ¼ã‚º',
  '057':'ç‹¬ç«‹ä¸å®šè©',
  '058':'be to ä¸å®šè©',
  '059':'é›£æ˜“åº¦ã‚’è¡¨ã™å½¢å®¹è©ï¼‹ toVï½',
  '060':'ä»£ä¸å®šè©',
  '061':'ä¸å®šè©ã®ç†Ÿèªâ‘ ',
  '062':'ä¸å®šè©ã®ç†Ÿèªâ‘¡',
  '063':'å‹•åè©ã®åŸºæœ¬',
  '064':'å‹•åè©ã¨ä¸å®šè©ã®é•ã„',
  '065':'å‹•åè©ã®æ„å‘³ä¸Šã®ä¸»èªã¨å¦å®šèªã®ä½ç½®',
  '066':'å‹•åè©ã®å—å‹•æ…‹',
  '067':'æ™‚åˆ¶ã®ä¸ä¸€è‡´',
  '068':'å‹•åè©ã‚’ä½¿ã£ãŸé‡è¦è¡¨ç¾â‘ ',
  '069':'å‹•åè©ã‚’ä½¿ã£ãŸé‡è¦è¡¨ç¾â‘¡',
  '070':'å‹•åè©ã¨ä¸å®šè©â‘ ',
  '071':'å‹•åè©ã¨ä¸å®šè©â‘¡',
  '072':'å‹•åè©ã¨ä¸å®šè©â‘¢',
  '073':'ç¾åœ¨åˆ†è©ã®åŸºæœ¬',
  '074':'éå»åˆ†è©ã®åŸºæœ¬',
  '075':'è£œèªã«ãªã‚‹åˆ†è©ï¼ˆç¬¬ï¼’æ–‡å‹ï¼‰',
  '076':'è£œèªã«ãªã‚‹åˆ†è©ï¼ˆç¬¬ï¼•æ–‡å‹ï¼‰â‘ ',
  '077':'è£œèªã«ãªã‚‹åˆ†è©ï¼ˆç¬¬ï¼•æ–‡å‹ï¼‰â‘¡',
  '078':'åˆ†è©æ§‹æ–‡ã®åŸºæœ¬',
  '079':'åˆ†è©æ§‹æ–‡ã®ä½œã‚Šæ–¹',
  '080':'åˆ†è©æ§‹æ–‡ã®å’Œè¨³',
  '081':'æ™‚åˆ¶ã®ä¸ä¸€è‡´ï¼†ç‹¬ç«‹åˆ†è©æ§‹æ–‡',
  '082':'æ¥ç¶šè©ã‚’çœç•¥ã—ãªã„åˆ†è©æ§‹æ–‡',
  '083':'æ…£ç”¨çš„ãªåˆ†è©æ§‹æ–‡',
  '084':'ä»˜å¸¯çŠ¶æ³ã‚’è¡¨ã™with',
  '085':'å½¢å®¹è©ã«ãªã£ã¡ã¾ã£ãŸåˆ†è©',
  '086':'ç›´æ¥æ³•ã¨ä»®å®šæ³•',
  '087':'ä»®å®šæ³•éå»ï¼ˆç¾åœ¨ã®å¦„æƒ³ï¼‰',
  '088':'ä»®å®šæ³•éå»å®Œäº†ï¼ˆéå»ã®å¦„æƒ³ï¼‰',
  '089':'ä»®å®šæ³•ãƒŸãƒƒã‚¯ã‚¹ï¼ˆéå»ã«ï½ã ã£ãŸã‚‰ã€ã„ã¾â€¦ãªã®ã«ãªãï¼‰',
  '090':'wishã¨as ifã‚’ç”¨ã„ãŸä»®å®šæ³•',
  '091':'æœªæ¥ã®å¦„æƒ³',
  '092':'ifã®çœç•¥',
  '093':'ifç¯€ã‚’ä½¿ã‚ãªã„ä»®å®šæ³•è¡¨ç¾',
  '094':'ä»®å®šæ³•ã‚’ä½¿ã£ãŸæ…£ç”¨è¡¨ç¾',
  '095':'é–¢ä¿‚ä»£åè©ã®åŸºæœ¬',
  '096':'é–¢ä¿‚ä»£åè©that',
  '097':'å‰ç½®è©ã¨é–¢ä¿‚ä»£åè©',
  '098':'é–¢ä¿‚å‰¯è©when',
  '099':'é–¢ä¿‚å‰¯è©whyã¨how',
  '100':'å…ˆè¡Œè©ã‚’çœç•¥ã§ãã‚‹ã‚±ãƒ¼ã‚¹',
  '101':'é–¢ä¿‚è©ã®éåˆ¶é™ç”¨æ³•',
  '102':'éåˆ¶é™ç”¨æ³•ã®ä½¿ã„æ–¹',
  '103':'é–¢ä¿‚å‰¯è©where',
  '104':'é–¢ä¿‚è©ä»£åè©what',
  '105':'é–¢ä¿‚è©ä»£åè©whatã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾',
  '106':'è¤‡åˆé–¢ä¿‚è©ã®æ¦‚è¦',
  '107':'åè©ç¯€ã‚’ä½œã‚‹è¤‡åˆé–¢ä¿‚ä»£åè©',
  '108':'å‰¯è©ç¯€ï¼ˆè­²æ­©ï¼‰ã‚’ä½œã‚‹è¤‡åˆé–¢ä¿‚ä»£åè©â‘ ',
  '109':'å‰¯è©ç¯€ï¼ˆè­²æ­©ï¼‰ã‚’ä½œã‚‹è¤‡åˆé–¢ä¿‚ä»£åè©â‘¡',
  '110':'é–¢ä¿‚ä»£åè©ã¨ã—ã¦ã®as',
  '111':'é–¢ä¿‚ä»£åè©ã¨ã—ã¦ã®thanã¨but',
  '112':'ãƒãƒ‹ã‚¢å‘ã‘é–¢ä¿‚ä»£åè©',
  '113':'åŸç´šæ¯”è¼ƒã®åŸºæœ¬',
  '114':'asã®å€æ•°è¡¨ç¾',
  '115':'asã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘ ',
  '116':'asã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘¡',
  '117':'asã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘¢',
  '118':'æ¯”è¼ƒç´šã®åŸºæœ¬',
  '119':'å·®ã‚’å…·ä½“çš„ã«è¡¨ã™æ¯”è¼ƒç´š',
  '120':'æ¯”è¼ƒç´šã®å€æ•°è¡¨ç¾',
  '121':'ä¸è¦å‰‡å¤‰åŒ–ã™ã‚‹å½¢å®¹è©ãƒ»å‰¯è©',
  '122':'lessã‚’ç”¨ã„ãŸæ¯”è¼ƒç´š',
  '123':'æ¯”è¼ƒç´šã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘ ',
  '124':'æ¯”è¼ƒç´šã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘¡',
  '125':'æ¯”è¼ƒç´šã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘¢',
  '126':'æ¯”è¼ƒç´šã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘£',
  '127':'noã‚’ä½¿ã£ãŸæ¯”è¼ƒè¡¨ç¾â‘ ',
  '128':'noã‚’ä½¿ã£ãŸæ¯”è¼ƒè¡¨ç¾â‘¡',
  '129':'æœ€ä¸Šç´šã®åŸºæœ¬',
  '130':'æœ€ä¸Šç´šã‚’ç”¨ã„ãŸè¡¨ç¾â‘ ',
  '131':'æœ€ä¸Šç´šã‚’ç”¨ã„ãŸè¡¨ç¾â‘¡',
  '132':'æœ€ä¸Šç´šã®æ„å‘³ã‚’è¡¨ã™åŸç´šãƒ»æ¯”è¼ƒè¡¨ç¾'
};
  for (const catKey of Object.keys(grammarData)) {
    const cat = grammarData[catKey];
    if (!cat || !Array.isArray(cat.items)) continue;
    cat.items = cat.items.map(it => {
      const id = String(it.id).trim();
      if (/^\d+$/.test(id)) {
        const key = id.padStart(3,'0');
        if (NAME_OVERRIDES[key]) return Object.assign({}, it, { id: key, name: NAME_OVERRIDES[key] });
        return Object.assign({}, it, { id: key });
      }
      return it;
    });
  }

  if (typeof normalizeTitle === 'function' && typeof normalizedTitleMap === 'object' && normalizedTitleMap) {
    Object.keys(NAME_OVERRIDES).forEach(k => {
      const nm = NAME_OVERRIDES[k];
      normalizedTitleMap[ normalizeTitle(nm) ] = k;
    });
    Object.values(grammarData).forEach(cat => {
      (cat.items||[]).forEach(it => {
        normalizedTitleMap[ normalizeTitle(it.name||'') ] = String(it.id);
      });
    });
  }
})();
// === END PATCH ===
</script>
</body>
</html>
