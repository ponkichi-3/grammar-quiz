<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>æ–‡æ³•4æŠãƒ†ã‚¹ãƒˆï¼ˆç¢ºèªå¼ï¼‹å¾©ç¿’ / ç®¡ç†ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ MCQç‰ˆï¼‰</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Hiragino Sans',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;overflow-x:hidden}
.container{background:#fff;border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,.1);max-width:900px;width:100%}
h1,h2{text-align:center;color:#333;margin-bottom:18px}
h1{font-size:26px}
.sub{font-size:13px;text-align:center;color:#718096;margin-bottom:18px}
.button{display:block;width:100%;padding:12px;margin-bottom:12px;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;transition:.2s;color:#fff;text-align:center;-webkit-appearance:none}
.button:hover{transform:translateY(-1px);box-shadow:0 5px 12px rgba(0,0,0,.2)}
.button-purple{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
.button-green{background:linear-gradient(135deg,#48bb78 0%,#2f855a 100%)}
.button-blue{background:linear-gradient(135deg,#3182ce 0%,#2c5282 100%)}
.button-gray{background:linear-gradient(135deg,#718096 0%,#4a5568 100%)}
.button-orange{background:linear-gradient(135deg,#ed8936 0%,#c05621 100%)}
.button-red{background:linear-gradient(135deg,#f56565 0%,#c53030 100%)}
.hidden{display:none !important}
.form-group{margin-bottom:14px}
label{display:block;margin-bottom:6px;font-weight:700;color:#4a5568;font-size:14px}
select,input[type=text]{width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:16px;transition:border-color .2s}
select:focus,input[type=text]:focus{outline:none;border-color:#667eea}
.checkbox-group{max-height:220px;overflow-y:auto;border:2px solid #e2e8f0;border-radius:8px;padding:12px}
.select-controls{display:flex;gap:10px;margin:8px 0}
.select-button{padding:8px 12px;border:2px solid #667eea;border-radius:8px;background:#fff;color:#667eea;cursor:pointer;font-size:14px;font-weight:600;transition:.15s}
.select-button:hover{background:#667eea;color:#fff}
.progress-bar{height:8px;background:#e2e8f0;border-radius:4px;margin-bottom:12px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,#667eea 0%,#48bb78 100%);transition:width .3s;border-radius:4px}
.timer{font-size:16px;color:#667eea;font-weight:700;text-align:center;margin-bottom:8px}
.quiz-container{text-align:left}
.question-box{background:#f8f9fa;border-radius:12px;padding:18px;margin-bottom:14px}
.question-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.question-number{font-size:14px;color:#718096;font-weight:600}
.point-badge{background:#667eea;color:#fff;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:700}
.question-title{font-size:13px;color:#4a5568;margin-bottom:6px;font-weight:600}
.question-text{font-size:20px;font-weight:700;color:#2d3748;line-height:1.5}
.choice{border:2px solid #e2e8f0;border-radius:10px;padding:10px;margin-top:10px;background:#fff;display:flex;gap:8px;align-items:flex-start}
.choice.correct{border-color:#48bb78;background:#f0fff4}
.choice.incorrect{border-color:#f56565;background:#fff5f5}
.choice input{margin-top:3px}
.model-answer{margin-top:10px;padding:12px;background:#e6fffa;border:2px solid #38b2ac;border-radius:8px;display:none}
.model-answer-label{font-size:12px;color:#2c7a7b;font-weight:700;margin-bottom:4px}
.model-answer-text{color:#234e52;font-size:15px;line-height:1.5}
.rate-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
.rate-btn{padding:10px;border:2px solid #e2e8f0;border-radius:10px;background:#fff;cursor:pointer;font-weight:700;transition:.15s}
.rate-btn.perfect{border-color:#48bb78}
.rate-btn.some{border-color:#ed8936}
.rate-btn.none{border-color:#f56565}
.rate-btn.selected{background:#f0f4ff;border-color:#667eea}
.rate-note{font-size:12px;color:#718096;text-align:center;margin-top:4px}
#rateFeedback{font-size:12px;color:#2c5282;text-align:center;margin-top:6px;display:none}
.hint-box{margin-top:10px;padding:12px;background:#fff7ed;border:2px solid #ed8936;border-radius:8px;display:none}
.hint-label{font-size:12px;color:#c05621;font-weight:700;margin-bottom:4px}
.hint-text{color:#7b341e;font-size:15px;line-height:1.5}
.hint-btn{display:inline-block;padding:8px 12px;border:2px solid #ed8936;border-radius:8px;background:#fff;cursor:pointer;font-size:14px;font-weight:700;color:#c05621;margin-top:10px}
.result-details{background:#f7fafc;border-radius:12px;padding:16px;margin:14px 0}
.result-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #e2e8f0}
.result-item:last-child{border-bottom:none}
.score-display{font-size:56px;font-weight:800;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin:10px 0;text-align:center}
.small{font-size:12px;color:#718096;text-align:center;margin-top:6px}
.home-fab{position:fixed;right:16px;bottom:16px;z-index:1000;display:flex;align-items:center;gap:8px;border:none;border-radius:999px;padding:10px 14px;font-weight:800;font-size:14px;cursor:pointer;background:linear-gradient(135deg,#805ad5 0%, #4c51bf 100%);color:#fff;box-shadow:0 10px 25px rgba(0,0,0,.2)}
.home-fab:active{transform:translateY(1px)}
.home-fab .icon{font-size:18px;line-height:1}
.mgmt-grid{display:grid;grid-template-columns:1fr;gap:16px}
.mgmt-section{border:1px solid #e2e8f0;border-radius:12px;padding:14px;background:#f9fafb}
.mgmt-title{font-weight:800;font-size:16px;color:#2d3748;margin-bottom:8px}
.mgmt-note{font-size:12px;color:#718096;margin-top:6px}
.item-list{max-height:360px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
.item-row{padding:10px 12px;border-bottom:1px solid #edf2f7}
.item-row:last-child{border-bottom:none}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700;background:#edf2ff;color:#374ea2;margin-left:6px}
.inline-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.inline-btn{padding:6px 10px;border:2px solid #667eea;border-radius:8px;background:#fff;color:#667eea;font-weight:700;cursor:pointer}
.inline-btn:hover{background:#667eea;color:#fff}
.code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px;color:#4a5568;background:#edf2f7;border-radius:6px;padding:2px 6px}
#err{display:none;margin-bottom:10px;padding:10px;border-radius:8px;background:#FED7D7;color:#822727;font-weight:700}
@media (max-width:480px){.rate-grid{grid-template-columns:1fr}.question-text{font-size:18px}.score-display{font-size:48px}}
</style>
</head>
<body>
<div class="container">
  <div id="err"></div>

  <div id="homeScreen">
    <h1>æ–‡æ³•ãƒ†ã‚¹ãƒˆï¼ˆç¢ºèªå¼ï¼‹å¾©ç¿’ï¼‰</h1>
    <div class="sub">MCQç‰ˆ / æ–‡æ³•4æŠå•é¡Œï¼ˆæ©Ÿèƒ½ã¯æ—¢å­˜ã¨åŒç­‰ï¼‰</div>
    <button class="button button-purple" id="btnTestMode">ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</button>
    <button class="button button-orange" id="btnPracticeMode">ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</button>
    <button class="button button-green" id="btnReviewMode">å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰</button>
    <button class="button button-blue" id="btnManagement">ç®¡ç†ãƒ¢ãƒ¼ãƒ‰</button>
    <div class="small">CSVã¯åŒãƒ•ã‚©ãƒ«ãƒ€ã® <code id="csvNameNote">grammar_mcq.csv</code> ã‚’è‡ªå‹•èª­è¾¼ã—ã¾ã™ã€‚</div>
  </div>

  <div id="settingsScreen" class="hidden">
    <h2>è¨­å®š</h2>
    <div class="form-group">
      <label>ãƒ¢ãƒ¼ãƒ‰</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px">
        <div id="modeTest" class="select-button" style="text-align:center">ãƒ†ã‚¹ãƒˆ</div>
        <div id="modePractice" class="select-button" style="text-align:center">ç·´ç¿’</div>
      </div>
      <div class="sub" id="modeNote">ã€Œè§£ç­”ã‚’ç¢ºèªã€ã§æ­£è§£ã‚’è¡¨ç¤º â†’ è¨˜æ†¶åº¦ã‚’3æŠã§è‡ªå·±è©•ä¾¡ï¼ˆ4æŠå¼ï¼‰</div>
    </div>

    <div class="form-group">
      <label>æ–‡æ³•å¤§é …ç›®ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
      <div class="select-controls">
        <button class="select-button" id="btnSelectAllMajor">å…¨ã¦é¸æŠ</button>
        <button class="select-button" id="btnDeselectAllMajor">å…¨ã¦è§£é™¤</button>
      </div>
      <div class="checkbox-group" id="majorGroup"></div>
    </div>

    <div class="form-group">
      <label>æ–‡æ³•å°é …ç›®ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
      <div class="select-controls">
        <button class="select-button" id="btnSelectAllItems">å…¨ã¦é¸æŠ</button>
        <button class="select-button" id="btnDeselectAllItems">å…¨ã¦è§£é™¤</button>
      </div>
      <div class="checkbox-group" id="subCategoryGroup"></div>
    </div>

    <div class="form-group">
      <label>å‡ºé¡Œé †</label>
      <select id="questionOrder">
        <option value="sequential">é †ç•ªé€šã‚Š</option>
        <option value="shuffle">ã‚·ãƒ£ãƒƒãƒ•ãƒ«</option>
      </select>
    </div>

    <div class="form-group">
      <label>å•é¡Œæ•°</label>
      <select id="questionCount">
        <option value="5">5å•</option>
        <option value="10" selected>10å•</option>
        <option value="all">å…¨å•é¡Œ</option>
      </select>
    </div>

    <div class="form-group" id="timeLimitGroup">
      <label>åˆ¶é™æ™‚é–“ï¼ˆãƒ†ã‚¹ãƒˆã®ã¿ï¼‰</label>
      <select id="timeLimit">
        <option value="5">5åˆ†</option>
        <option value="10" selected>10åˆ†</option>
        <option value="15">15åˆ†</option>
        <option value="0">ç„¡åˆ¶é™</option>
      </select>
    </div>

    <div id="studentInfoGroup">
      <div class="form-group">
        <label>æ°åï¼ˆãƒ†ã‚¹ãƒˆã®ã¿ä»»æ„ï¼‰</label>
        <input id="studentName" type="text" placeholder="ä¾‹: å±±ç”°å¤ªéƒ"/>
      </div>
    </div>

    <button class="button button-blue" id="btnStartTest">é–‹å§‹</button>
    <button class="button button-gray" id="btnBackFromSettings">æˆ»ã‚‹</button>
  </div>

  <div id="quizScreen" class="hidden">
    <div id="timer" class="timer"></div>
    <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>

    <div class="quiz-container">
      <div class="question-box">
        <div class="question-header">
          <div id="questionNumber" class="question-number"></div>
          <div id="pointBadge" class="point-badge"></div>
        </div>
        <div id="questionTitle" class="question-title"></div>
        <div id="questionText" class="question-text"></div>

        <div id="choiceArea"></div>

        <button id="hintButton" class="hint-btn" type="button" style="display:none">ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹</button>
        <div id="hintBox" class="hint-box">
          <div class="hint-label">ãƒ’ãƒ³ãƒˆ</div>
          <div id="hintText" class="hint-text"></div>
        </div>

        <button id="confirmButton" class="button button-blue">è§£ç­”ã‚’ç¢ºèª</button>
        <div id="modelAnswer" class="model-answer">
          <div class="model-answer-label">æ­£è§£</div>
          <div id="modelAnswerText" class="model-answer-text"></div>
        </div>
      </div>

      <div>
        <div id="rateArea" class="hidden">
          <div class="rate-grid">
            <button id="btnPerfect" class="rate-btn perfect">å®Œç’§ã«è¦šãˆãŸ</button>
            <button id="btnSome" class="rate-btn some">ã¾ã å®Œç’§ã§ã¯ãªã„</button>
            <button id="btnNone" class="rate-btn none">ãœã‚“ãœã‚“è¦šãˆã‚‰ã‚Œã¦ã„ãªã„</button>
          </div>
          <div id="rateFeedback">ä¿å­˜ã—ã¾ã—ãŸã€‚</div>
          <div class="rate-note">â€»ã€Œã¾ã ã€ã€Œãœã‚“ãœã‚“ã€ã§å¾©ç¿’ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰</div>
        </div>

        <button id="nextButton" class="button button-blue hidden">æ¬¡ã®å•é¡Œã¸</button>
        <button id="finishButton" class="button button-orange hidden">ãƒ†ã‚¹ãƒˆã‚’çµ‚äº†</button>
      </div>
    </div>
  </div>

  <div id="resultScreen" class="hidden">
    <h2>çµ‚äº†</h2>
    <div id="scoreDisplay" class="score-display"></div>
    <div class="result-details">
      <div class="result-item"><span>å•é¡Œæ•°</span><span id="totalCount"></span></div>
      <div class="result-item"><span>æ‰€è¦æ™‚é–“</span><span id="elapsedTime"></span></div>
      <div class="result-item"><span>å¾©ç¿’ã«è¿½åŠ </span><span id="reviewAddedCount"></span></div>
    </div>
    <div id="detailedResults" class="small"></div>
    <button class="button button-green" id="btnReviewFromResult">å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã§ã‚„ã‚‹</button>
    <button class="button button-gray" id="btnHomeFromResult">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
  </div>

  <div id="managementScreen" class="hidden">
    <h2>ç®¡ç†ãƒ¢ãƒ¼ãƒ‰</h2>
    <div class="mgmt-grid">
      <div class="mgmt-section">
        <div class="mgmt-title">å¾©ç¿’ãƒªã‚¹ãƒˆç®¡ç†</div>
        <div id="reviewListBox" class="item-list"></div>
        <div class="inline-controls">
          <button class="inline-btn" id="btnExportReview">å¾©ç¿’ãƒªã‚¹ãƒˆã‚’æ›¸ãå‡ºã™</button>
          <button class="inline-btn" id="btnImportReview">å¾©ç¿’ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€</button>
          <button class="button button-red" style="width:auto" id="btnClearReview">å¾©ç¿’ãƒªã‚¹ãƒˆã‚’å…¨å‰Šé™¤</button>
        </div>
        <div class="mgmt-note">ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚’åˆ©ç”¨ã€‚ç«¯æœ«é–“å…±æœ‰ã¯ä¸å¯ã€‚</div>
      </div>
      <div class="mgmt-section">
        <div class="mgmt-title">é …ç›®åˆ¥ã®å•é¡Œä¸€è¦§</div>
        <div class="form-group">
          <label>æ–‡æ³•å°é …ç›®ï¼ˆPOINTï¼‰ã‚’é¸æŠ</label>
          <select id="itemSelector">
            <option value="">ï¼ˆå°é …ç›®ã‚’é¸æŠï¼‰</option>
          </select>
        </div>
        <div id="itemInfo" class="small" style="text-align:left;margin-bottom:8px;"></div>
        <div id="itemQuestionsBox" class="item-list"></div>
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="button button-gray" style="width:auto" id="btnHomeFromMgmt">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
    </div>
  </div>
</div>

<button class="home-fab" id="homeFab" title="ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹"><span class="icon">ğŸ </span><span>ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</span></button>

<script>
// ãƒ‡ãƒ¼ã‚¿ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
const DEFAULT_CSVS = ['grammar_mcq.csv', 'grammar_definition_with_examples2.csv', 'grammar_definition.csv'];
let questionData=[];
let currentQuestions=[];
let currentQuestion=0;
let startTime=null;
let timerInterval=null;
let timeLimit=10;
let testMode='test';
let selectedCategories=[];
let reviewPool=[];
let reviewAddedNow=0;
let selectedAnswer=null;
let correctCount=0;

const grammarData = {
  tense:{name:"æ™‚åˆ¶ï¼ˆTENSEï¼‰",items:[
    {id:"001",name:"åŸºæœ¬ï¼”æ™‚åˆ¶ã®å®šç¾©"},{id:"002",name:"æ§˜ã€…ãªæœªæ¥è¡¨ç¾"},{id:"003",name:"é€²è¡Œå½¢ã®å®šç¾©"},
    {id:"004",name:"é€²è¡Œå½¢ã®ãƒ«ãƒ¼ãƒ«"},{id:"005",name:"ã€Œæ™‚ã‚„æ¡ä»¶ã€ã‚’è¡¨ã™å‰¯è©ç¯€ã§ç”¨ã„ã‚‹ç¾åœ¨å½¢"},
    {id:"006",name:"ç¾åœ¨å®Œäº†å½¢ã®ç”¨æ³•â‘ ï½å®Œäº†ãƒ»çµæœãƒ»çµŒé¨“ï½"},{id:"007",name:"ç¾åœ¨å®Œäº†å½¢ã®ç”¨æ³•â‘¡ï½ç¶™ç¶šï½"},
    {id:"008",name:"ç¾åœ¨å®Œäº†å½¢ã®ç”¨æ³•â‘¢ï½æ³¨æ„ç‚¹ï½"},{id:"009",name:"éå»å®Œäº†å½¢ã®ç”¨æ³•â‘ ï½å®Œäº†ãƒ»çµæœãƒ»çµŒé¨“ï½"},
    {id:"010",name:"éå»å®Œäº†å½¢ã®ç”¨æ³•â‘¡ï½ç¶™ç¶šï½"},{id:"011",name:"éå»å®Œäº†å½¢ã®ç”¨æ³•â‘¢ï½å¤§éå»ï½"},
    {id:"012",name:"æœªæ¥å®Œäº†å½¢ã®ç”¨æ³•â‘ ï½å®Œäº†ãƒ»çµæœãƒ»çµŒé¨“ã¨ç¶™ç¶šï½"},{id:"013",name:"æœªæ¥å®Œäº†å½¢ã®ç”¨æ³•â‘¡ï½æ³¨æ„ç‚¹ï½"}
  ]},
  voice:{name:"å—å‹•æ…‹ï¼ˆVOICEï¼‰",items:[
    {id:"014",name:"å—å‹•æ…‹ã®åŸºæœ¬"},{id:"015",name:"æ§˜ã€…ãªå½¢ã®å—å‹•æ…‹"},{id:"016",name:"å—å‹•æ…‹ã®ç–‘å•æ–‡"},
    {id:"017",name:"ç¬¬ï¼”æ–‡å‹ã®å—å‹•æ…‹"},{id:"018",name:"ç¬¬ï¼•æ–‡å‹ã®å—å‹•æ…‹"},{id:"019",name:"æ€è€ƒèªçŸ¥å‘Šç¤ºå‹•è©ã®å—å‹•æ…‹"},
    {id:"020",name:"æ³¨æ„ã™ã¹ãå—å‹•æ…‹ã®è¡¨ç¾â‘ ï½be knownï½"},{id:"021",name:"æ³¨æ„ã™ã¹ãå—å‹•æ…‹ã®è¡¨ç¾â‘¡ï½æ„Ÿæƒ…è¡¨ç¾ï½"},
    {id:"022",name:"æ³¨æ„ã™ã¹ãå—å‹•æ…‹ã®è¡¨ç¾â‘¢ï½è¢«å®³è¡¨ç¾ï½"},{id:"023",name:"æ³¨æ„ã™ã¹ãå—å‹•æ…‹ã®è¡¨ç¾â‘£ï½ãã®ä»–ã®é »å‡ºè¡¨ç¾ï½"},
    {id:"024",name:"beå‹•è©ã®ä»£ã‚ã‚Šã«ä½¿ãˆã‚‹ã€Œå‹•ä½œå‹•è©ã€ã¨ã€ŒçŠ¶æ…‹å‹•è©"},{id:"025",name:"æ³¨æ„ã™ã¹ãå—å‹•æ…‹ã®è¡¨ç¾â‘¤ï½å—å‹•æ…‹ã‚’ä½¿ã‚ãªã„è¡¨ç¾ï½"},
    {id:"026",name:"ç¾¤å‹•è©ï¼ˆç†Ÿèªï¼‰ã®å—å‹•æ…‹"}
  ]},
  auxiliary:{name:"åŠ©å‹•è©ï¼ˆAUXILIARY VERBï¼‰",items:[
    {id:"027",name:"canã®åŸºæœ¬"},{id:"028",name:"couldã‚’ç†è§£ã—ã‚ˆã†"},{id:"029",name:"mayã®åŸºæœ¬"},{id:"030",name:"mightã®åŸºæœ¬"},
    {id:"031",name:"mustã®åŸºæœ¬"},{id:"032",name:"mustã¨have toã®é•ã„ã‚’ç†è§£ã—ã‚ˆã†"},{id:"033",name:"shouldã®åŸºæœ¬"},
    {id:"034",name:"shouldã®ä»²é–“â‘  ought toV"},{id:"035",name:"shouldã®ä»²é–“â‘¡had better VåŸå½¢"},{id:"036",name:"willã®åŸºæœ¬"},
    {id:"037",name:"wouldã®åŸºæœ¬"},{id:"038",name:"used to VåŸå½¢ï½ã®åŸºæœ¬"},{id:"039",name:"shallã®åŸºæœ¬"},
    {id:"040",name:"needã®åŸºæœ¬"},{id:"041",name:"åŠ©å‹•è© have Vp.p.ã‚·ãƒªãƒ¼ã‚º"},{id:"042",name:"æ…£ç”¨è¡¨ç¾ã‚·ãƒªãƒ¼ã‚º"},
    {id:"043",name:"thatç¯€ã§ç”¨ã„ã‚‰ã‚Œã‚‹æƒ³å¿µã®shouldâ‘ "},{id:"044",name:"thatç¯€ã§ç”¨ã„ã‚‰ã‚Œã‚‹æƒ³å¿µã®shouldâ‘¡"}
  ]},
  infinitive:{name:"ä¸å®šè©ï¼ˆINFINITIVEï¼‰",items:[
    {id:"045",name:"ä¸å®šè©ã®åŸºæœ¬â‘  åè©çš„ç”¨æ³•"},{id:"046",name:"ä¸å®šè©ã®åŸºæœ¬â‘¡ å½¢å®¹è©çš„ç”¨æ³•"},{id:"047",name:"ä¸å®šè©ã®åŸºæœ¬â‘¢ å‰¯è©çš„ç”¨æ³•"},
    {id:"048",name:"ï¼³ï¼¶ï¼¯ï¼‹toï¼¶ï½"},{id:"049",name:"ä¸å®šè©ã®æ„å‘³ä¸Šã®ä¸»èªâ‘ "},{id:"050",name:"ä¸å®šè©ã®æ„å‘³ä¸Šã®ä¸»èªâ‘¡"},
    {id:"051",name:"ä½¿å½¹å‹•è©ï¼ˆåŸå½¢ä¸å®šè©ï¼‰"},{id:"052",name:"çŸ¥è¦šå‹•è©"},{id:"053",name:"ï½ã‚ˆã†ã ã‚·ãƒªãƒ¼ã‚º"},{id:"054",name:"æ™‚åˆ¶ã®ä¸ä¸€è‡´"},
    {id:"055",name:"æ§˜ã€…ãªå½¢ã®ä¸å®šè©ï½é€²è¡Œå½¢ãƒ»å—å‹•æ…‹ãƒ»å¦å®šï½"},{id:"056",name:"ç–‘å•è© toVï½ã‚·ãƒªãƒ¼ã‚º"},{id:"057",name:"ç‹¬ç«‹ä¸å®šè©"},
    {id:"058",name:"be to ä¸å®šè©"},{id:"059",name:"é›£æ˜“åº¦ã‚’è¡¨ã™å½¢å®¹è©ï¼‹ toVï½"},{id:"060",name:"ä»£ä¸å®šè©"},
    {id:"061",name:"ä¸å®šè©ã®ç†Ÿèªâ‘ "},{id:"062",name:"ä¸å®šè©ã®ç†Ÿèªâ‘¡"}
  ]},
  gerund:{name:"å‹•åè©ï¼ˆGERUNDï¼‰",items:[
    {id:"063",name:"å‹•åè©ã®åŸºæœ¬"},{id:"064",name:"å‹•åè©ã¨ä¸å®šè©ã®é•ã„"},{id:"065",name:"å‹•åè©ã®æ„å‘³ä¸Šã®ä¸»èªã¨å¦å®šèªã®ä½ç½®"},
    {id:"066",name:"å‹•åè©ã®å—å‹•æ…‹"},{id:"067",name:"æ™‚åˆ¶ã®ä¸ä¸€è‡´"},{id:"068",name:"å‹•åè©ã‚’ä½¿ã£ãŸé‡è¦è¡¨ç¾â‘ "},
    {id:"069",name:"å‹•åè©ã‚’ä½¿ã£ãŸé‡è¦è¡¨ç¾â‘¡"},{id:"070",name:"å‹•åè©ã¨ä¸å®šè©â‘ "},{id:"071",name:"å‹•åè©ã¨ä¸å®šè©â‘¡"},
    {id:"072",name:"å‹•åè©ã¨ä¸å®šè©â‘¢"}
  ]},
  participle:{name:"åˆ†è©ï¼ˆPARTICIPLEï¼‰",items:[
    {id:"073",name:"ç¾åœ¨åˆ†è©ã®åŸºæœ¬"},{id:"074",name:"éå»åˆ†è©ã®åŸºæœ¬"},{id:"075",name:"è£œèªã«ãªã‚‹åˆ†è©ï¼ˆç¬¬ï¼’æ–‡å‹ï¼‰"},
    {id:"076",name:"è£œèªã«ãªã‚‹åˆ†è©ï¼ˆç¬¬ï¼•æ–‡å‹ï¼‰â‘ "},{id:"077",name:"è£œèªã«ãªã‚‹åˆ†è©ï¼ˆç¬¬ï¼•æ–‡å‹ï¼‰â‘¡"},
    {id:"078",name:"åˆ†è©æ§‹æ–‡ã®åŸºæœ¬"},{id:"079",name:"åˆ†è©æ§‹æ–‡ã®ä½œã‚Šæ–¹"},{id:"080",name:"åˆ†è©æ§‹æ–‡ã®å’Œè¨³"},
    {id:"081",name:"æ™‚åˆ¶ã®ä¸ä¸€è‡´ï¼†ç‹¬ç«‹åˆ†è©æ§‹æ–‡"},{id:"082",name:"æ¥ç¶šè©ã‚’çœç•¥ã—ãªã„åˆ†è©æ§‹æ–‡"},{id:"083",name:"æ…£ç”¨çš„ãªåˆ†è©æ§‹æ–‡"},
    {id:"084",name:"ä»˜å¸¯çŠ¶æ³ã‚’è¡¨ã™with"},{id:"085",name:"å½¢å®¹è©ã«ãªã£ã¡ã¾ã£ãŸåˆ†è©"}
  ]},
  subjunctive:{name:"ä»®å®šæ³•ï¼ˆSUBJUNCTIVEï¼‰",items:[
    {id:"086",name:"ç›´æ¥æ³•ã¨ä»®å®šæ³•"},{id:"087",name:"ä»®å®šæ³•éå»ï¼ˆç¾åœ¨ã®å¦„æƒ³ï¼‰"},{id:"088",name:"ä»®å®šæ³•éå»å®Œäº†ï¼ˆéå»ã®å¦„æƒ³ï¼‰"},
    {id:"089",name:"wishã¨as ifã‚’ç”¨ã„ãŸä»®å®šæ³•"},{id:"090",name:"æœªæ¥ã®å¦„æƒ³"},{id:"091",name:"ifã®çœç•¥"},
    {id:"092",name:"ifç¯€ã‚’ä½¿ã‚ãªã„ä»®å®šæ³•è¡¨ç¾"},{id:"093",name:"ä»®å®šæ³•ã‚’ä½¿ã£ãŸæ…£ç”¨è¡¨ç¾"},{id:"094",name:"ä»®å®šæ³•ãƒŸãƒƒã‚¯ã‚¹ï¼ˆéå»ã«ï½ã ã£ãŸã‚‰ã€ã„ã¾â€¦ãªã®ã«ãªãï¼‰"}
  ]},
  relative:{name:"é–¢ä¿‚è©ï¼ˆRELATIVE PRONOUNï¼‰",items:[
    {id:"095",name:"é–¢ä¿‚ä»£åè©ã®åŸºæœ¬"},{id:"096",name:"é–¢ä¿‚ä»£åè©that"},{id:"097",name:"å‰ç½®è©ã¨é–¢ä¿‚ä»£åè©"},
    {id:"098",name:"é–¢ä¿‚å‰¯è©when"},{id:"099",name:"é–¢ä¿‚å‰¯è©whyã¨how"},{id:"100",name:"å…ˆè¡Œè©ã‚’çœç•¥ã§ãã‚‹ã‚±ãƒ¼ã‚¹"},
    {id:"101",name:"é–¢ä¿‚è©ã®éåˆ¶é™ç”¨æ³•"},{id:"102",name:"éåˆ¶é™ç”¨æ³•ã®ä½¿ã„æ–¹"},{id:"103",name:"é–¢ä¿‚å‰¯è©where"},
    {id:"104",name:"é–¢ä¿‚è©ä»£åè©what"},{id:"105",name:"é–¢ä¿‚è©ä»£åè©whatã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾"},
    {id:"106",name:"è¤‡åˆé–¢ä¿‚è©ã®æ¦‚è¦"},{id:"107",name:"å‰¯è©ç¯€ï¼ˆè­²æ­©ï¼‰ã‚’ä½œã‚‹è¤‡åˆé–¢ä¿‚ä»£åè©â‘ "},
    {id:"108",name:"å‰¯è©ç¯€ï¼ˆè­²æ­©ï¼‰ã‚’ä½œã‚‹è¤‡åˆé–¢ä¿‚ä»£åè©â‘¡"},{id:"109",name:"åè©ç¯€ã‚’ä½œã‚‹è¤‡åˆé–¢ä¿‚ä»£åè©"},
    {id:"110",name:"é–¢ä¿‚ä»£åè©ã¨ã—ã¦ã®thanã¨but"},{id:"111",name:"é–¢ä¿‚ä»£åè©ã¨ã—ã¦ã®as"},{id:"112",name:"ãƒãƒ‹ã‚¢å‘ã‘é–¢ä¿‚ä»£åè©"}
  ]},
  comparison:{name:"æ¯”è¼ƒï¼ˆCOMPARISONï¼‰",items:[
    {id:"113",name:"åŸç´šæ¯”è¼ƒã®åŸºæœ¬"},{id:"114",name:"asã®å€æ•°è¡¨ç¾"},{id:"115",name:"asã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘ "},
    {id:"116",name:"asã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘¡"},{id:"117",name:"asã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘¢"},{id:"118",name:"æ¯”è¼ƒç´šã®åŸºæœ¬"},
    {id:"119",name:"å·®ã‚’å…·ä½“çš„ã«è¡¨ã™æ¯”è¼ƒç´š"},{id:"120",name:"æ¯”è¼ƒç´šã®å€æ•°è¡¨ç¾"},{id:"121",name:"ä¸è¦å‰‡å¤‰åŒ–ã™ã‚‹å½¢å®¹è©ãƒ»å‰¯è©"},
    {id:"122",name:"lessã‚’ç”¨ã„ãŸæ¯”è¼ƒç´š"},{id:"123",name:"æ¯”è¼ƒç´šã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘ "},{id:"124",name:"æ¯”è¼ƒç´šã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘¡"},
    {id:"125",name:"æ¯”è¼ƒç´šã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘¢"},{id:"126",name:"æ¯”è¼ƒç´šã‚’ç”¨ã„ãŸæ…£ç”¨è¡¨ç¾â‘£"},
    {id:"127",name:"noã‚’ä½¿ã£ãŸæ¯”è¼ƒè¡¨ç¾â‘ "},{id:"128",name:"noã‚’ä½¿ã£ãŸæ¯”è¼ƒè¡¨ç¾â‘¡"},
    {id:"129",name:"æœ€ä¸Šç´šã®åŸºæœ¬"},{id:"130",name:"æœ€ä¸Šç´šã‚’ç”¨ã„ãŸè¡¨ç¾â‘ "},{id:"131",name:"æœ€ä¸Šç´šã‚’ç”¨ã„ãŸè¡¨ç¾â‘¡"},
    {id:"132",name:"æœ€ä¸Šç´šã®æ„å‘³ã‚’è¡¨ã™åŸç´šãƒ»æ¯”è¼ƒè¡¨ç¾"}
  ]}
};

// ç”»é¢åˆ¶å¾¡
function showScreen(screenId) {
  console.log('Showing screen:', screenId);
  const screens = ['homeScreen', 'settingsScreen', 'quizScreen', 'resultScreen', 'managementScreen'];
  screens.forEach(id => {
    const el = document.getElementById(id);
    if(el) el.classList.add('hidden');
  });
  const target = document.getElementById(screenId);
  if(target) target.classList.remove('hidden');
}

function backToHome() { 
  resetState(); 
  showScreen('homeScreen'); 
}

function resetState() {
  currentQuestions=[]; 
  currentQuestion=0; 
  startTime=null; 
  if(timerInterval) clearInterval(timerInterval);
  reviewAddedNow=0; 
  selectedAnswer=null; 
  correctCount=0;
}

// ãƒ¢ãƒ¼ãƒ‰é¸æŠ
function selectMode(m) {
  testMode = m;
  document.getElementById('timeLimitGroup').style.display = (m === 'test') ? 'block' : 'none';
  document.getElementById('studentInfoGroup').style.display = (m === 'test') ? 'block' : 'none';
  
  const testBtn = document.getElementById('modeTest');
  const practiceBtn = document.getElementById('modePractice');
  
  if(m === 'test') {
    testBtn.style.background = '#667eea';
    testBtn.style.color = '#fff';
    practiceBtn.style.background = '#fff';
    practiceBtn.style.color = '#667eea';
  } else {
    practiceBtn.style.background = '#667eea';
    practiceBtn.style.color = '#fff';
    testBtn.style.background = '#fff';
    testBtn.style.color = '#667eea';
  }
}

// CSVå‡¦ç†
async function autoLoadCSV() {
  for(const name of DEFAULT_CSVS) {
    try {
      const res = await fetch(name, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const text = await res.text();
      const rows = parseCSV(text);
      questionData = rowsToQuestions(rows);
      console.log(`Loaded ${questionData.length} questions from ${name}`);
      const note = document.getElementById('csvNameNote');
      if(note) note.textContent = name;
      return;
    } catch(e) { 
      console.warn(`Failed to load ${name}:`, e); 
    }
  }
  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  questionData = [{
    id:'001',
    question:'It is wrong (     ) a lie.',
    choices:['to tell','to telling','tell','having told'],
    answer:'to tell',
    point:'POINT 045',
    title:'ä¸å®šè©ã®åŸºæœ¬â‘  åè©çš„ç”¨æ³•',
    hint:'ä»®ä¸»èªIt + beå½¢å®¹è© + toä¸å®šè© ã®åŸºæœ¬',
    subId:'045'
  }];
}

function parseCSV(text) {
  const rows = [];
  let row = [];
  let cur = '';
  let inQ = false;
  
  for(let i = 0; i < text.length; i++) {
    const c = text[i];
    const n = text[i + 1];
    if(inQ) {
      if(c === '"') {
        if(n === '"') { cur += '"'; i++; }
        else { inQ = false; }
      } else {
        cur += c;
      }
    } else {
      if(c === '"') { inQ = true; }
      else if(c === ',') { row.push(cur); cur = ''; }
      else if(c === '\r') {}
      else if(c === '\n') { row.push(cur); rows.push(row); row = []; cur = ''; }
      else { cur += c; }
    }
  }
  if(cur.length > 0 || row.length > 0) {
    row.push(cur);
    rows.push(row);
  }
  return rows;
}

function rowsToQuestions(rows) {
  if(!rows || !rows.length) return [];
  const header = rows[0].map(h => (h||'').toLowerCase().trim());
  
  const idx = (name) => header.indexOf(name.toLowerCase());
  const idI = idx('id');
  const qI = idx('question');
  const aI = idx('answer');
  const pI = idx('point');
  const tI = idx('title');
  const hI = idx('hint') >= 0 ? idx('hint') : idx('hints');
  const c1I = idx('choice1');
  const c2I = idx('choice2');
  const c3I = idx('choice3');
  const c4I = idx('choice4');
  
  const out = [];
  for(let i = 1; i < rows.length; i++) {
    const r = rows[i];
    if(!r || r.length === 0) continue;
    
    const get = (I) => (I >= 0 && I < r.length) ? (r[I] || '') : '';
    const id = get(idI).toString().trim();
    if(!id) continue;
    
    const pointRaw = get(pI).toString();
    let subId = id.padStart(3, '0');
    const m = pointRaw.match(/(\d{1,3})/);
    if(m) {
      const num = parseInt(m[1], 10);
      if(num >= 1 && num <= 132) subId = String(num).padStart(3, '0');
    }
    
    const choices = [get(c1I), get(c2I), get(c3I), get(c4I)].filter(x => x !== '');
    
    out.push({
      id: id.padStart(3, '0'),
      question: get(qI).toString().trim(),
      choices: choices.length ? choices : [],
      answer: get(aI).toString().trim(),
      point: pointRaw.trim(),
      title: get(tI).toString().trim(),
      subId: subId,
      hint: get(hI).toString().trim()
    });
  }
  return out;
}

// å¾©ç¿’ãƒ—ãƒ¼ãƒ«
const REVIEW_KEY = 'grammarReviewPoolV1';

function loadReviewPool() {
  try {
    reviewPool = JSON.parse(localStorage.getItem(REVIEW_KEY) || '[]');
    if(!Array.isArray(reviewPool)) reviewPool = [];
  } catch(_) {
    reviewPool = [];
  }
}

function saveReviewPool() {
  localStorage.setItem(REVIEW_KEY, JSON.stringify(reviewPool));
}

function addToReview(q) {
  if(!q || !q.id) return;
  if(!reviewPool.some(x => String(x.id) === String(q.id))) {
    reviewPool.push(q);
    saveReviewPool();
    reviewAddedNow++;
  }
}

// ã‚«ãƒ†ã‚´ãƒªUI
function buildCategoryUI() {
  const major = document.getElementById('majorGroup');
  if(!major) return;
  major.innerHTML = '';
  
  Object.keys(grammarData).forEach(key => {
    const label = document.createElement('label');
    label.style.display = 'flex';
    label.style.alignItems = 'center';
    label.style.padding = '4px 0';
    label.style.cursor = 'pointer';
    label.style.fontSize = '14px';
    
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.value = key;
    checkbox.style.marginRight = '8px';
    checkbox.addEventListener('change', updateSubCategories);
    
    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(grammarData[key].name));
    major.appendChild(label);
  });
}

function updateSubCategories() {
  const sub = document.getElementById('subCategoryGroup');
  if(!sub) return;
  sub.innerHTML = '';
  
  const checkedMajors = [...document.querySelectorAll('#majorGroup input[type=checkbox]:checked')].map(cb => cb.value);
  const keys = checkedMajors.length ? checkedMajors : Object.keys(grammarData);
  
  keys.forEach(key => {
    const header = document.createElement('div');
    header.style.fontWeight = '700';
    header.style.color = '#667eea';
    header.style.marginTop = '10px';
    header.style.marginBottom = '4px';
    header.style.fontSize = '15px';
    header.textContent = grammarData[key].name;
    sub.appendChild(header);
    
    grammarData[key].items.forEach(item => {
      const label = document.createElement('label');
      label.style.display = 'flex';
      label.style.alignItems = 'center';
      label.style.padding = '4px 0';
      label.style.cursor = 'pointer';
      label.style.fontSize = '14px';
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = item.id;
      checkbox.style.marginRight = '8px';
      checkbox.addEventListener('change', updateSelectedCategories);
      
      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(`${item.id}. ${item.name}`));
      sub.appendChild(label);
    });
  });
}

function updateSelectedCategories() {
  selectedCategories = [...document.querySelectorAll('#subCategoryGroup input[type=checkbox]:checked')].map(cb => cb.value.padStart(3, '0'));
}

function selectAllItems() {
  document.querySelectorAll('#subCategoryGroup input[type=checkbox]').forEach(cb => cb.checked = true);
  updateSelectedCategories();
}

function deselectAllItems() {
  document.querySelectorAll('#subCategoryGroup input[type=checkbox]').forEach(cb => cb.checked = false);
  updateSelectedCategories();
}

// ãƒ†ã‚¹ãƒˆé–‹å§‹
function startTest() {
  if(selectedCategories.length === 0) {
    alert('æ–‡æ³•å°é …ç›®ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');
    return;
  }
  
  let filtered = questionData.filter(q => selectedCategories.includes(String(q.subId).padStart(3, '0')));
  if(filtered.length === 0) {
    alert('é¸æŠã—ãŸé …ç›®ã«å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }
  
  const order = document.getElementById('questionOrder').value;
  if(order === 'shuffle') filtered = shuffle(filtered);
  
  const count = document.getElementById('questionCount').value;
  if(count !== 'all') filtered = filtered.slice(0, parseInt(count, 10));
  
  currentQuestions = filtered.map(q => ({...q}));
  currentQuestion = 0;
  reviewAddedNow = 0;
  correctCount = 0;
  
  if(testMode === 'test') {
    timeLimit = parseInt(document.getElementById('timeLimit').value || '10', 10);
    startTime = Date.now();
    if(timeLimit > 0) {
      timerInterval = setInterval(updateTimer, 1000);
      updateTimer();
    }
  }
  
  showScreen('quizScreen');
  renderQuestion();
}

function updateTimer() {
  const elapsed = Math.floor((Date.now() - startTime) / 1000);
  const remaining = timeLimit * 60 - elapsed;
  if(remaining <= 0) {
    clearInterval(timerInterval);
    finishTest();
    return;
  }
  const mm = String(Math.floor(remaining / 60)).padStart(2, '0');
  const ss = String(remaining % 60).padStart(2, '0');
  document.getElementById('timer').textContent = `æ®‹ã‚Šæ™‚é–“: ${mm}:${ss}`;
}

// å•é¡Œè¡¨ç¤º
function renderQuestion() {
  if(currentQuestion >= currentQuestions.length) {
    finishTest();
    return;
  }
  
  const q = currentQuestions[currentQuestion];
  document.getElementById('questionNumber').textContent = `å•${currentQuestion + 1} / ${currentQuestions.length}`;
  document.getElementById('pointBadge').textContent = q.point || '';
  document.getElementById('questionTitle').textContent = q.title || '';
  document.getElementById('questionText').innerHTML = (q.question || '').split('|').join('<br>');
  
  const choiceArea = document.getElementById('choiceArea');
  choiceArea.innerHTML = '';
  
  const choices = q.choices.length === 4 ? q.choices : inferChoicesFromAnswer(q);
  choices.forEach((c, i) => {
    const line = document.createElement('div');
    line.className = 'choice';
    line.innerHTML = `
      <input type="radio" name="choice" id="ch${i}" value="${escapeHTML(c)}">
      <label for="ch${i}" style="display:block;flex:1">${escapeHTML(c)}</label>
    `;
    choiceArea.appendChild(line);
  });
  
  // é€²æ—ãƒãƒ¼
  const progress = ((currentQuestion + 1) / currentQuestions.length) * 100;
  document.getElementById('progressFill').style.width = progress + '%';
  
  // ãƒªã‚»ãƒƒãƒˆ
  document.getElementById('modelAnswer').style.display = 'none';
  document.getElementById('rateArea').classList.add('hidden');
  document.getElementById('nextButton').classList.add('hidden');
  document.getElementById('finishButton').classList.add('hidden');
  document.getElementById('confirmButton').disabled = false;
  
  // ãƒ’ãƒ³ãƒˆ
  const hintBtn = document.getElementById('hintButton');
  const hintBox = document.getElementById('hintBox');
  if(q.hint && q.hint.trim()) {
    hintBtn.style.display = 'inline-block';
    document.getElementById('hintText').innerHTML = q.hint.split('|').join('<br>');
  } else {
    hintBtn.style.display = 'none';
  }
  hintBox.style.display = 'none';
}

function inferChoicesFromAnswer(q) {
  const ans = q.answer || '';
  const pool = ['to tell', 'to saying', 'says', 'telling', 'told', 'to be told', 'to have told', 'tell'];
  const others = shuffle(pool.filter(x => x !== ans)).slice(0, 3);
  return shuffle([ans, ...others]);
}

// è§£ç­”ç¢ºèª
function confirmAnswer() {
  const radios = document.querySelectorAll('input[name="choice"]');
  let sel = null;
  radios.forEach(r => { if(r.checked) sel = r.value; });
  
  if(!sel) {
    alert('é¸æŠè‚¢ã‚’é¸ã‚“ã§ãã ã•ã„');
    return;
  }
  
  selectedAnswer = sel;
  const q = currentQuestions[currentQuestion];
  const correct = normalizeAns(sel) === normalizeAns(q.answer || '');
  if(correct) correctCount++;
  
  // è‰²ä»˜ã‘
  const lines = [...document.querySelectorAll('.choice')];
  lines.forEach(line => {
    const v = line.querySelector('input')?.value || '';
    if(normalizeAns(v) === normalizeAns(q.answer || '')) line.classList.add('correct');
    if(normalizeAns(v) === normalizeAns(sel) && !correct) line.classList.add('incorrect');
  });
  
  document.getElementById('modelAnswerText').textContent = q.answer || '';
  document.getElementById('modelAnswer').style.display = 'block';
  document.getElementById('rateArea').classList.remove('hidden');
  document.getElementById('confirmButton').disabled = true;
  document.getElementById('nextButton').classList.remove('hidden');
  
  if(currentQuestion === currentQuestions.length - 1) {
    document.getElementById('finishButton').classList.remove('hidden');
  }
}

function normalizeAns(s) {
  return (s || '').toString().trim().replace(/\s+/g, ' ').toLowerCase();
}

// è©•ä¾¡
function rateCurrent(level) {
  const q = currentQuestions[currentQuestion];
  
  ['btnPerfect', 'btnSome', 'btnNone'].forEach(id => {
    document.getElementById(id).classList.remove('selected');
  });
  
  document.getElementById(
    level === 'perfect' ? 'btnPerfect' :
    level === 'some' ? 'btnSome' : 'btnNone'
  ).classList.add('selected');
  
  const fb = document.getElementById('rateFeedback');
  if(level === 'some' || level === 'none') {
    addToReview(q);
    fb.textContent = 'å¾©ç¿’ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸã€‚';
  } else {
    fb.textContent = 'äº†è§£ã€‚æ¬¡ã¸é€²ã‚ã¾ã™ã€‚';
  }
  fb.style.display = 'block';
}

// æ¬¡ã®å•é¡Œ
function nextQuestion() {
  currentQuestion++;
  renderQuestion();
}

// çµ‚äº†
function finishTest() {
  if(timerInterval) clearInterval(timerInterval);
  
  const total = currentQuestions.length;
  let elapsed = 0;
  if(startTime) {
    elapsed = Math.floor((Date.now() - startTime) / 1000);
  }
  const mm = String(Math.floor(elapsed / 60)).padStart(2, '0');
  const ss = String(elapsed % 60).padStart(2, '0');
  
  document.getElementById('totalCount').textContent = total;
  document.getElementById('elapsedTime').textContent = `${mm}:${ss}`;
  document.getElementById('reviewAddedCount').textContent = reviewAddedNow;
  document.getElementById('scoreDisplay').textContent = `${correctCount} / ${total} æ­£ç­”`;
  
  showScreen('resultScreen');
}

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
function shuffle(arr) {
  const a = arr.slice();
  for(let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function escapeHTML(s) {
  return (s || '').toString().replace(/[&<>"']/g, m => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  }[m]));
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
document.addEventListener('DOMContentLoaded', async () => {
  console.log('Initializing...');
  
  // ãƒ›ãƒ¼ãƒ ç”»é¢ãƒœã‚¿ãƒ³
  document.getElementById('btnTestMode').addEventListener('click', () => {
    showScreen('settingsScreen');
    selectMode('test');
    updateSubCategories();
  });
  
  document.getElementById('btnPracticeMode').addEventListener('click', () => {
    showScreen('settingsScreen');
    selectMode('practice');
    updateSubCategories();
  });
  
  document.getElementById('btnReviewMode').addEventListener('click', () => {
    loadReviewPool();
    if(!reviewPool.length) {
      alert('å¾©ç¿’ãƒªã‚¹ãƒˆãŒç©ºã§ã™ã€‚ã€Œã¾ã ï¼ãœã‚“ãœã‚“ã€ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    testMode = 'review';
    currentQuestions = reviewPool.map(q => ({...q}));
    currentQuestion = 0;
    reviewAddedNow = 0;
    correctCount = 0;
    document.getElementById('timer').textContent = '';
    showScreen('quizScreen');
    renderQuestion();
  });
  
  document.getElementById('btnManagement').addEventListener('click', () => {
    showScreen('managementScreen');
  });
  
  // è¨­å®šç”»é¢
  document.getElementById('modeTest').addEventListener('click', () => selectMode('test'));
  document.getElementById('modePractice').addEventListener('click', () => selectMode('practice'));
  document.getElementById('btnSelectAllMajor').addEventListener('click', () => {
    document.querySelectorAll('#majorGroup input[type=checkbox]').forEach(cb => cb.checked = true);
    updateSubCategories();
  });
  document.getElementById('btnDeselectAllMajor').addEventListener('click', () => {
    document.querySelectorAll('#majorGroup input[type=checkbox]').forEach(cb => cb.checked = false);
    updateSubCategories();
  });
  document.getElementById('btnSelectAllItems').addEventListener('click', selectAllItems);
  document.getElementById('btnDeselectAllItems').addEventListener('click', deselectAllItems);
  document.getElementById('btnStartTest').addEventListener('click', startTest);
  document.getElementById('btnBackFromSettings').addEventListener('click', backToHome);
  
  // ã‚¯ã‚¤ã‚ºç”»é¢
  document.getElementById('hintButton').addEventListener('click', () => {
    const box = document.getElementById('hintBox');
    box.style.display = box.style.display === 'none' ? 'block' : 'none';
  });
  document.getElementById('confirmButton').addEventListener('click', confirmAnswer);
  document.getElementById('btnPerfect').addEventListener('click', () => rateCurrent('perfect'));
  document.getElementById('btnSome').addEventListener('click', () => rateCurrent('some'));
  document.getElementById('btnNone').addEventListener('click', () => rateCurrent('none'));
  document.getElementById('nextButton').addEventListener('click', nextQuestion);
  document.getElementById('finishButton').addEventListener('click', finishTest);
  
  // çµæœç”»é¢
  document.getElementById('btnReviewFromResult').addEventListener('click', () => {
    loadReviewPool();
    if(!reviewPool.length) {
      alert('å¾©ç¿’ãƒªã‚¹ãƒˆãŒç©ºã§ã™ã€‚');
      return;
    }
    testMode = 'review';
    currentQuestions = reviewPool.map(q => ({...q}));
    currentQuestion = 0;
    reviewAddedNow = 0;
    correctCount = 0;
    showScreen('quizScreen');
    renderQuestion();
  });
  document.getElementById('btnHomeFromResult').addEventListener('click', backToHome);
  
  // ç®¡ç†ç”»é¢
  document.getElementById('btnHomeFromMgmt').addEventListener('click', backToHome);
  
  // FABãƒœã‚¿ãƒ³
  document.getElementById('homeFab').addEventListener('click', () => {
    const quizVisible = !document.getElementById('quizScreen').classList.contains('hidden');
    if(quizVisible && currentQuestions.length) {
      if(!confirm('é€²è¡Œä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¦ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    }
    backToHome();
  });
  
  // åˆæœŸåŒ–
  buildCategoryUI();
  updateSubCategories();
  selectAllItems();
  loadReviewPool();
  await autoLoadCSV();
  
  console.log('Initialization complete');
});
</script>
</body>
</html>